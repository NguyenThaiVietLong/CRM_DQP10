<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Migration Tool - Add Task Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
      <h1 class="text-2xl font-bold text-gray-900 mb-4">ğŸ”§ Migration Tool</h1>
      <p class="text-gray-600 mb-6">
        CÃ´ng cá»¥ nÃ y sáº½ thÃªm field <code>status</code> cho táº¥t cáº£ tasks chÆ°a cÃ³
      </p>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <h3 class="font-bold text-blue-800 mb-2">â„¹ï¸ ThÃ´ng tin:</h3>
        <ul class="text-sm text-blue-700 space-y-1">
          <li>â€¢ Tasks chÆ°a cÃ³ status â†’ <strong>Chá» nháº­n nhiá»‡m vá»¥</strong></li>
          <li>â€¢ Tasks Ä‘Ã£ completed â†’ <strong>HoÃ n thÃ nh</strong></li>
          <li>â€¢ Activity-level status sáº½ bá»‹ xÃ³a</li>
        </ul>
      </div>

      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <h3 class="font-bold text-yellow-800 mb-2">âš ï¸ Task Status Workflow:</h3>
        <ul class="text-sm text-yellow-700 space-y-1">
          <li>ğŸŸ¡ <strong>Chá» nháº­n nhiá»‡m vá»¥</strong> - Task má»›i Ä‘Æ°á»£c assign</li>
          <li>ğŸ”µ <strong>ChÆ°a báº¯t Ä‘áº§u</strong> - ÄÃ£ xÃ¡c nháº­n nháº­n task</li>
          <li>ğŸŸ¢ <strong>HoÃ n thÃ nh</strong> - Task Ä‘Ã£ xong</li>
        </ul>
      </div>

      <button
        onclick="migrateActivities()"
        class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-bold hover:bg-blue-700 transition-colors"
      >
        Cháº¡y Migration
      </button>

      <div id="result" class="mt-6 hidden">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <h3 class="font-bold text-green-800 mb-2">âœ… Káº¿t quáº£:</h3>
          <pre
            id="resultContent"
            class="text-sm text-green-700 whitespace-pre-wrap"
          ></pre>
        </div>
      </div>

      <div class="mt-6 text-center">
        <a href="activity-list.html" class="text-blue-600 hover:underline"
          >â† Quay láº¡i danh sÃ¡ch</a
        >
      </div>
    </div>

    <script>
      function migrateActivities() {
        const data = localStorage.getItem("dqp10_activities");
        if (!data) {
          alert("âŒ KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u activities trong localStorage");
          return;
        }

        try {
          const activities = JSON.parse(data);
          let updatedActivities = 0;
          let updatedTasks = 0;

          activities.forEach((activity) => {
            // Remove activity-level status
            if (activity.status) {
              delete activity.status;
              updatedActivities++;
            }

            // Add status to each task
            if (activity.tasks && Array.isArray(activity.tasks)) {
              activity.tasks.forEach((task) => {
                if (!task.status) {
                  // If task is already completed, set status to HoÃ n thÃ nh
                  if (task.completed) {
                    task.status = "HoÃ n thÃ nh";
                  } else {
                    // Default status for new tasks
                    task.status = "Chá» nháº­n nhiá»‡m vá»¥";
                  }
                  updatedTasks++;
                }
              });
            }
          });

          // Save back to localStorage
          localStorage.setItem("dqp10_activities", JSON.stringify(activities));

          // Show results
          const resultDiv = document.getElementById("result");
          const resultContent = document.getElementById("resultContent");

          resultContent.textContent =
            `âœ… ÄÃ£ xá»­ lÃ½ ${activities.length} activities\n` +
            `âœ… ÄÃ£ xÃ³a activity-level status tá»« ${updatedActivities} activities\n` +
            `âœ… ÄÃ£ thÃªm status cho ${updatedTasks} tasks\n\n` +
            `Má»—i task bÃ¢y giá» cÃ³ status riÃªng:\n` +
            `â€¢ Chá» nháº­n nhiá»‡m vá»¥ - Tasks má»›i\n` +
            `â€¢ ChÆ°a báº¯t Ä‘áº§u - ÄÃ£ xÃ¡c nháº­n nháº­n\n` +
            `â€¢ HoÃ n thÃ nh - ÄÃ£ xong`;

          resultDiv.classList.remove("hidden");

          // Auto redirect after 2 seconds
          setTimeout(() => {
            if (
              confirm("âœ… Migration hoÃ n táº¥t!\n\nChuyá»ƒn sang trang danh sÃ¡ch?")
            ) {
              window.location.href = "activity-list.html";
            }
          }, 1000);
        } catch (error) {
          alert("âŒ Lá»—i khi migration: " + error.message);
          console.error(error);
        }
      }
    </script>
  </body>
</html>
