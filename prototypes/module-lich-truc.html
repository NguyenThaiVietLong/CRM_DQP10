<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>L·ªãch Tr·ª±c D√¢n Qu√¢n - Ph∆∞·ªùng ƒë·ªôi B√¨nh Ph√∫</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="notification-system.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { olive: "#556B2F" },
          },
        },
      };
    </script>
    <style>
      [x-cloak] {
        display: none !important;
      }
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
    </style>
  </head>
  <body
    class="bg-gray-50 font-sans antialiased"
    x-data="dutySchedule()"
    x-init="init()"
  >
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside
        class="w-64 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col p-4 hidden md:flex h-full"
      >
        <div class="flex gap-3 px-2 py-2 mb-4">
          <img src="logo-dqtv.png" alt="Logo" class="size-10 object-contain" />
          <div class="flex flex-col justify-center">
            <h1 class="text-gray-900 text-base font-bold">
              Ph∆∞·ªùng ƒë·ªôi B√¨nh Ph√∫
            </h1>
            <p class="text-gray-500 text-xs">H·ªá th·ªëng qu·∫£n l√Ω</p>
          </div>
        </div>

        <!-- User Profile -->
        <div
          class="mb-4 p-3 bg-gradient-to-r from-olive/10 to-olive/5 rounded-lg border border-olive/20"
        >
          <div class="flex items-center gap-2">
            <div class="relative">
              <div
                class="size-10 rounded-full bg-olive/20 flex items-center justify-center"
              >
                <span class="material-symbols-outlined text-olive text-2xl"
                  >account_circle</span
                >
              </div>
              <span
                class="absolute bottom-0 right-0 size-3 bg-green-500 border-2 border-white rounded-full"
              ></span>
            </div>
            <div class="flex-1 min-w-0">
              <p
                class="text-sm font-bold text-gray-900 truncate"
                x-text="currentUser.fullName || 'Guest'"
              ></p>
              <p class="text-xs text-gray-600">
                <span
                  class="px-2 py-0.5 rounded-full text-xs font-medium"
                  :class="{'bg-blue-100 text-blue-700': currentUser.role === 'dqtt', 'bg-orange-100 text-orange-700': currentUser.role === 'admin'}"
                  x-text="currentUser.role === 'admin' ? 'Admin' : (currentUser.team || 'DQTT')"
                ></span>
              </p>
            </div>
          </div>
        </div>

        <nav class="flex flex-col gap-2">
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="index.html"
          >
            <span class="material-symbols-outlined text-gray-600">home</span>
            <p class="text-sm font-medium text-gray-600">Trang ch·ªß</p>
          </a>
          <a
            x-show="currentUser.role === 'admin'"
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="dashboard-tong-hop.html"
          >
            <span class="material-symbols-outlined text-gray-600"
              >assessment</span
            >
            <p class="text-sm font-medium text-gray-600">Dashboard</p>
          </a>

          <!-- Ho·∫°t ƒë·ªông Submenu -->
          <div>
            <div class="flex items-center gap-3 px-3 py-2 text-gray-700">
              <span class="material-symbols-outlined text-gray-600">event</span>
              <p class="text-sm font-bold text-gray-700">Ho·∫°t ƒë·ªông</p>
            </div>
            <div class="ml-6 space-y-1 border-l-2 border-gray-200 pl-3">
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="activity-list.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">Danh s√°ch</p>
              </a>
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="activity-calendar.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">L·ªãch</p>
              </a>
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-olive/10 text-olive"
                href="module-lich-truc.html"
              >
                <span class="size-1.5 rounded-full bg-olive"></span>
                <p class="text-sm font-bold">L·ªãch tr·ª±c</p>
              </a>
            </div>
          </div>
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="module2-personnel-complete.html"
          >
            <span class="material-symbols-outlined text-gray-600">group</span>
            <p class="text-sm font-medium text-gray-600">Nh√¢n s·ª±</p>
          </a>
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="module3-inventory-complete.html"
          >
            <span class="material-symbols-outlined text-gray-600"
              >inventory_2</span
            >
            <p class="text-sm font-medium text-gray-600">Kho</p>
          </a>
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="module4-documents-complete.html"
          >
            <span class="material-symbols-outlined text-gray-600">folder</span>
            <p class="text-sm font-medium text-gray-600">T√†i li·ªáu</p>
          </a>
        </nav>

        <div class="mt-auto pt-4 border-t border-gray-200 space-y-2">
          <a
            @click.prevent="logout()"
            href="#"
            class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-bold bg-olive text-white hover:bg-olive/90 transition-colors justify-center cursor-pointer"
          >
            <span class="material-symbols-outlined text-xl">logout</span>
            <span>ƒêƒÉng xu·∫•t</span>
          </a>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold text-gray-900">
                L·ªãch Tr·ª±c D√¢n Qu√¢n
              </h1>
              <p class="text-sm text-gray-500 mt-1">
                Qu·∫£n l√Ω l·ªãch tr·ª±c tu·∫ßn cho c√°c t·ªï d√¢n qu√¢n
              </p>
            </div>
            <div class="flex items-center gap-3">
              <!-- Notification Bell System -->
              <div x-data="notificationBell" class="relative">
                <button
                  @click="toggleDropdown()"
                  class="relative p-2 hover:bg-gray-100 rounded-lg transition-colors"
                  :class="{'bg-gray-100': isOpen}"
                >
                  <span class="material-symbols-outlined">notifications</span>
                  <span
                    x-show="unreadCount > 0"
                    class="absolute top-2 right-2 size-2 bg-red-500 rounded-full"
                  ></span>
                  <span
                    x-show="unreadCount > 0"
                    x-text="unreadCount"
                    class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full px-1.5 py-0.5 min-w-[20px] text-center"
                  ></span>
                </button>
                <div
                  x-show="isOpen"
                  @click.away="isOpen = false"
                  class="absolute right-0 mt-2 w-96 bg-white rounded-xl shadow-2xl border border-gray-200 z-50"
                  style="display: none"
                  x-cloak
                >
                  <div
                    class="px-4 py-3 border-b border-gray-200 flex items-center justify-between"
                  >
                    <h3 class="text-sm font-bold text-gray-900">
                      Th√¥ng b√°o nhi·ªám v·ª•
                    </h3>
                    <span
                      class="text-xs text-gray-500"
                      x-text="notifications.length + ' nhi·ªám v·ª•'"
                    ></span>
                  </div>
                  <div class="max-h-96 overflow-y-auto">
                    <template x-if="notifications.length === 0">
                      <div class="p-8 text-center">
                        <span
                          class="material-symbols-outlined text-4xl text-gray-300"
                          >notifications_off</span
                        >
                        <p class="text-sm text-gray-500 mt-2">
                          Kh√¥ng c√≥ th√¥ng b√°o m·ªõi
                        </p>
                      </div>
                    </template>
                    <div class="divide-y divide-gray-100">
                      <template x-for="notif in notifications" :key="notif.id">
                        <div class="p-4 hover:bg-gray-50 transition-colors">
                          <div class="flex items-start gap-3">
                            <div
                              class="bg-yellow-100 rounded-lg p-2 flex-shrink-0"
                            >
                              <span
                                class="material-symbols-outlined text-yellow-600 text-xl"
                                >assignment</span
                              >
                            </div>
                            <div class="flex-1 min-w-0">
                              <p
                                class="text-sm font-semibold text-gray-900 mb-1"
                                x-text="notif.taskName"
                              ></p>
                              <div class="space-y-1 mb-2">
                                <p
                                  class="text-xs text-gray-600 flex items-center gap-1"
                                >
                                  <span
                                    class="material-symbols-outlined text-[14px]"
                                    >location_on</span
                                  >
                                  <span x-text="notif.location"></span>
                                </p>
                                <p
                                  class="text-xs text-gray-600 flex items-center gap-1"
                                >
                                  <span
                                    class="material-symbols-outlined text-[14px]"
                                    >schedule</span
                                  >
                                  <span
                                    >Th·ªùi h·∫°n:
                                    <span x-text="notif.deadline"></span
                                  ></span>
                                </p>
                              </div>
                              <div class="flex gap-2">
                                <a
                                  :href="'activity-detail.html?id=' + notif.activityId"
                                  class="text-xs text-olive hover:underline font-medium"
                                  >Xem chi ti·∫øt</a
                                >
                                <button
                                  @click="confirmRead(notif.id)"
                                  class="text-xs text-blue-600 hover:underline font-medium"
                                >
                                  X√°c nh·∫≠n ƒë√£ ƒë·ªçc
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                  <div
                    x-show="notifications.length > 0"
                    class="px-4 py-3 border-t border-gray-200 bg-gray-50"
                  >
                    <button
                      @click="markAllRead()"
                      class="text-xs text-olive hover:underline font-medium w-full text-center"
                    >
                      ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
                    </button>
                  </div>
                </div>
              </div>

              <!-- Week Navigation -->
              <button
                @click="previousWeek()"
                class="p-2 hover:bg-gray-100 rounded-lg"
              >
                <span class="material-symbols-outlined">chevron_left</span>
              </button>
              <div class="text-center min-w-[200px]">
                <p
                  class="text-lg font-bold text-gray-900"
                  x-text="currentWeekText"
                ></p>
              </div>
              <button
                @click="nextWeek()"
                class="p-2 hover:bg-gray-100 rounded-lg"
              >
                <span class="material-symbols-outlined">chevron_right</span>
              </button>
              <button
                x-show="currentUser.role === 'admin'"
                @click="saveSchedule()"
                class="px-4 py-2 bg-olive text-white rounded-lg hover:bg-olive/90 text-sm font-semibold flex items-center gap-2"
              >
                <span class="material-symbols-outlined text-lg">save</span>
                <span>L∆∞u l·ªãch</span>
              </button>
              <button
                @click="exportExcel()"
                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-semibold flex items-center gap-2"
              >
                <span class="material-symbols-outlined text-lg">download</span>
                <span>Xu·∫•t Excel</span>
              </button>
            </div>
          </div>
        </header>

        <!-- Schedule Table -->
        <div class="flex-1 overflow-auto p-6">
          <div
            class="bg-white rounded-lg border border-gray-200 overflow-x-auto"
          >
            <table class="w-full">
              <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th
                    class="px-4 py-3 text-left text-sm font-bold text-gray-700 sticky left-0 bg-gray-50 z-10 min-w-[120px]"
                  >
                    Th·ª©/Ng√†y
                  </th>
                  <th
                    class="px-4 py-3 text-center text-sm font-bold text-gray-700 min-w-[150px]"
                  >
                    Tr·ª±c ch·ªâ huy
                  </th>
                  <th
                    class="px-4 py-3 text-center text-sm font-bold text-gray-700 min-w-[150px]"
                  >
                    Tr·ª±c ban
                  </th>
                  <th
                    class="px-4 py-3 text-center text-sm font-bold text-gray-700 min-w-[150px]"
                  >
                    Tr·ª±c c√¥ng vƒÉn
                  </th>
                  <th
                    class="px-4 py-3 text-center text-sm font-bold text-gray-700 min-w-[150px]"
                  >
                    Tr·ª±c n·ªôi v·ª•
                  </th>
                  <th
                    class="px-4 py-3 text-center text-sm font-bold text-gray-700 min-w-[150px]"
                  >
                    Tr·ª±c c∆°m
                  </th>
                  <th
                    class="px-4 py-3 text-center text-sm font-bold text-gray-700 min-w-[200px]"
                  >
                    Tr·ª±c tr·ª• s·ªü HƒêND - UBND; ƒê·∫£ng ·ªßy
                  </th>
                  <th
                    class="px-4 py-3 text-center text-sm font-bold text-gray-700 min-w-[150px]"
                  >
                    DQTT ph·ª• tr√°ch A
                  </th>
                  <th
                    class="px-4 py-3 text-center text-sm font-bold text-gray-700 min-w-[150px]"
                  >
                    DQCD Tr·ª±c - Tu·∫ßn tra
                  </th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(day, idx) in weekDays" :key="day.date">
                  <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <!-- Day column (sticky) -->
                    <td
                      class="px-4 py-3 font-semibold text-gray-700 bg-gray-50 sticky left-0 z-10"
                    >
                      <div x-text="day.dayName"></div>
                      <div
                        class="text-xs font-normal text-gray-500"
                        x-text="day.dateStr"
                      ></div>
                    </td>

                    <!-- Tr·ª±c ch·ªâ huy -->
                    <td class="px-4 py-3 text-center relative">
                      <div
                        @click="handleCellClick(idx, 'trucChiHuy')"
                        :class="isEditable ? 'cursor-pointer hover:bg-gray-100 rounded p-2' : 'cursor-default p-2'"
                        x-text="day.trucChiHuy"
                      ></div>
                      <div
                        x-show="editingCell && editingCell.dayIdx === idx && editingCell.field === 'trucChiHuy'"
                        @click.away="editingCell = null"
                        class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-xl p-3 w-64 mt-1 left-1/2 transform -translate-x-1/2"
                        x-cloak
                      >
                        <input
                          x-model="searchQuery"
                          type="text"
                          placeholder="T√¨m ki·∫øm..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 text-sm focus:outline-none focus:ring-2 focus:ring-olive"
                        />
                        <div class="max-h-60 overflow-y-auto">
                          <template
                            x-for="user in filteredUsers"
                            :key="user.name"
                          >
                            <div
                              @click="selectUser(user.name)"
                              class="px-3 py-2 hover:bg-olive/10 cursor-pointer rounded text-sm"
                              x-text="user.name + ' (' + user.team + ')'"
                            ></div>
                          </template>
                        </div>
                      </div>
                    </td>

                    <!-- Tr·ª±c ban -->
                    <td class="px-4 py-3 text-center relative">
                      <div
                        @click="handleCellClick(idx, 'trucBan')"
                        :class="isEditable ? 'cursor-pointer hover:bg-gray-100 rounded p-2' : 'cursor-default p-2'"
                        x-text="day.trucBan"
                      ></div>
                      <div
                        x-show="editingCell && editingCell.dayIdx === idx && editingCell.field === 'trucBan'"
                        @click.away="editingCell = null"
                        class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-xl p-3 w-64 mt-1 left-1/2 transform -translate-x-1/2"
                        x-cloak
                      >
                        <input
                          x-model="searchQuery"
                          type="text"
                          placeholder="T√¨m ki·∫øm..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 text-sm focus:outline-none focus:ring-2 focus:ring-olive"
                        />
                        <div class="max-h-60 overflow-y-auto">
                          <template
                            x-for="user in filteredUsers"
                            :key="user.name"
                          >
                            <div
                              @click="selectUser(user.name)"
                              class="px-3 py-2 hover:bg-olive/10 cursor-pointer rounded text-sm"
                              x-text="user.name + ' (' + user.team + ')'"
                            ></div>
                          </template>
                        </div>
                      </div>
                    </td>

                    <!-- Tr·ª±c c√¥ng vƒÉn -->
                    <td class="px-4 py-3 text-center relative">
                      <div
                        @click="handleCellClick(idx, 'trucCongVan')"
                        :class="isEditable ? 'cursor-pointer hover:bg-gray-100 rounded p-2' : 'cursor-default p-2'"
                        x-text="day.trucCongVan"
                      ></div>
                      <div
                        x-show="editingCell && editingCell.dayIdx === idx && editingCell.field === 'trucCongVan'"
                        @click.away="editingCell = null"
                        class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-xl p-3 w-64 mt-1 left-1/2 transform -translate-x-1/2"
                        x-cloak
                      >
                        <input
                          x-model="searchQuery"
                          type="text"
                          placeholder="T√¨m ki·∫øm..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 text-sm focus:outline-none focus:ring-2 focus:ring-olive"
                        />
                        <div class="max-h-60 overflow-y-auto">
                          <template
                            x-for="user in filteredUsers"
                            :key="user.name"
                          >
                            <div
                              @click="selectUser(user.name)"
                              class="px-3 py-2 hover:bg-olive/10 cursor-pointer rounded text-sm"
                              x-text="user.name + ' (' + user.team + ')'"
                            ></div>
                          </template>
                        </div>
                      </div>
                    </td>

                    <!-- Tr·ª±c n·ªôi v·ª• -->
                    <td class="px-4 py-3 text-center relative">
                      <div
                        @click="handleCellClick(idx, 'trucNoiVu')"
                        :class="isEditable ? 'cursor-pointer hover:bg-gray-100 rounded p-2' : 'cursor-default p-2'"
                        x-text="day.trucNoiVu"
                      ></div>
                      <div
                        x-show="editingCell && editingCell.dayIdx === idx && editingCell.field === 'trucNoiVu'"
                        @click.away="editingCell = null"
                        class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-xl p-3 w-64 mt-1 left-1/2 transform -translate-x-1/2"
                        x-cloak
                      >
                        <input
                          x-model="searchQuery"
                          type="text"
                          placeholder="T√¨m ki·∫øm..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 text-sm focus:outline-none focus:ring-2 focus:ring-olive"
                        />
                        <div class="max-h-60 overflow-y-auto">
                          <template
                            x-for="user in filteredUsers"
                            :key="user.name"
                          >
                            <div
                              @click="selectUser(user.name)"
                              class="px-3 py-2 hover:bg-olive/10 cursor-pointer rounded text-sm"
                              x-text="user.name + ' (' + user.team + ')'"
                            ></div>
                          </template>
                        </div>
                      </div>
                    </td>

                    <!-- Tr·ª±c c∆°m -->
                    <td class="px-4 py-3 text-center relative">
                      <div
                        @click="handleCellClick(idx, 'trucCom')"
                        :class="isEditable ? 'cursor-pointer hover:bg-gray-100 rounded p-2' : 'cursor-default p-2'"
                        x-text="day.trucCom"
                      ></div>
                      <div
                        x-show="editingCell && editingCell.dayIdx === idx && editingCell.field === 'trucCom'"
                        @click.away="editingCell = null"
                        class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-xl p-3 w-64 mt-1 left-1/2 transform -translate-x-1/2"
                        x-cloak
                      >
                        <input
                          x-model="searchQuery"
                          type="text"
                          placeholder="T√¨m ki·∫øm..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 text-sm focus:outline-none focus:ring-2 focus:ring-olive"
                        />
                        <div class="max-h-60 overflow-y-auto">
                          <template
                            x-for="user in filteredUsers"
                            :key="user.name"
                          >
                            <div
                              @click="selectUser(user.name)"
                              class="px-3 py-2 hover:bg-olive/10 cursor-pointer rounded text-sm"
                              x-text="user.name + ' (' + user.team + ')'"
                            ></div>
                          </template>
                        </div>
                      </div>
                    </td>

                    <!-- Tr·ª±c tr·ª• s·ªü HƒêND - UBND; ƒê·∫£ng ·ªßy -->
                    <td class="px-4 py-3 text-center relative">
                      <div
                        @click="handleCellClick(idx, 'trucTruSo')"
                        :class="isEditable ? 'cursor-pointer hover:bg-gray-100 rounded p-2' : 'cursor-default p-2'"
                        x-text="day.trucTruSo"
                      ></div>
                      <div
                        x-show="editingCell && editingCell.dayIdx === idx && editingCell.field === 'trucTruSo'"
                        @click.away="editingCell = null"
                        class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-xl p-3 w-64 mt-1 left-1/2 transform -translate-x-1/2"
                        x-cloak
                      >
                        <input
                          x-model="searchQuery"
                          type="text"
                          placeholder="T√¨m ki·∫øm..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 text-sm focus:outline-none focus:ring-2 focus:ring-olive"
                        />
                        <div class="max-h-60 overflow-y-auto">
                          <template
                            x-for="user in filteredUsers"
                            :key="user.name"
                          >
                            <div
                              @click="selectUser(user.name)"
                              class="px-3 py-2 hover:bg-olive/10 cursor-pointer rounded text-sm"
                              x-text="user.name + ' (' + user.team + ')'"
                            ></div>
                          </template>
                        </div>
                      </div>
                    </td>

                    <!-- DQTT ph·ª• tr√°ch A -->
                    <td class="px-4 py-3 text-center relative">
                      <div
                        @click="handleCellClick(idx, 'dqttPhuTrach')"
                        :class="isEditable ? 'cursor-pointer hover:bg-gray-100 rounded p-2' : 'cursor-default p-2'"
                        x-text="day.dqttPhuTrach"
                      ></div>
                      <div
                        x-show="editingCell && editingCell.dayIdx === idx && editingCell.field === 'dqttPhuTrach'"
                        @click.away="editingCell = null"
                        class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-xl p-3 w-64 mt-1 left-1/2 transform -translate-x-1/2"
                        x-cloak
                      >
                        <input
                          x-model="searchQuery"
                          type="text"
                          placeholder="T√¨m ki·∫øm..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 text-sm focus:outline-none focus:ring-2 focus:ring-olive"
                        />
                        <div class="max-h-60 overflow-y-auto">
                          <template
                            x-for="user in filteredUsers"
                            :key="user.name"
                          >
                            <div
                              @click="selectUser(user.name)"
                              class="px-3 py-2 hover:bg-olive/10 cursor-pointer rounded text-sm"
                              x-text="user.name + ' (' + user.team + ')'"
                            ></div>
                          </template>
                        </div>
                      </div>
                    </td>

                    <!-- DQCD Tr·ª±c - Tu·∫ßn tra -->
                    <td class="px-4 py-3 text-center relative">
                      <div
                        @click="handleCellClick(idx, 'dqcdTruc')"
                        :class="isEditable ? 'cursor-pointer hover:bg-gray-100 rounded p-2' : 'cursor-default p-2'"
                        x-text="day.dqcdTruc"
                      ></div>
                      <div
                        x-show="editingCell && editingCell.dayIdx === idx && editingCell.field === 'dqcdTruc'"
                        @click.away="editingCell = null"
                        class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-xl p-3 w-64 mt-1 left-1/2 transform -translate-x-1/2"
                        x-cloak
                      >
                        <input
                          x-model="searchQuery"
                          type="text"
                          placeholder="T√¨m ki·∫øm..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 text-sm focus:outline-none focus:ring-2 focus:ring-olive"
                        />
                        <div class="max-h-60 overflow-y-auto">
                          <template
                            x-for="user in filteredUsers"
                            :key="user.name"
                          >
                            <div
                              @click="selectUser(user.name)"
                              class="px-3 py-2 hover:bg-olive/10 cursor-pointer rounded text-sm"
                              x-text="user.name + ' (' + user.team + ')'"
                            ></div>
                          </template>
                        </div>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>

          <!-- Notes -->
          <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h3 class="font-bold text-blue-900 mb-2">üìã H∆∞·ªõng d·∫´n:</h3>
            <ul class="text-sm text-blue-800 space-y-1">
              <li>
                <span x-show="currentUser.role === 'admin'"
                  >‚Ä¢ Click v√†o √¥ ƒë·ªÉ ch·ªçn ng∆∞·ªùi tr·ª±c t·ª´ danh s√°ch</span
                ><span x-show="currentUser.role !== 'admin'"
                  >‚Ä¢ B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô xem (ch·ªâ Admin m·ªõi c√≥ th·ªÉ ch·ªânh
                  s·ª≠a)</span
                >
              </li>
              <li>
                ‚Ä¢ Tr·ª±c ch·ªâ huy lu√¢n phi√™n: V√µ Tr·∫ßn Vinh ‚Üí Tr·∫ßn Anh Tu·∫•n ‚Üí L∆∞∆°ng
                Tri·ªáu Ph√°t
              </li>
              <li>
                ‚Ä¢ C√°c v·ªã tr√≠ kh√°c ƒë∆∞·ª£c g√°n ng·∫´u nhi√™n t·ª´ danh s√°ch d√¢n qu√¢n
              </li>
              <li x-show="currentUser.role === 'admin'">
                ‚Ä¢ Nh·∫•n "L∆∞u l·ªãch" ƒë·ªÉ l∆∞u thay ƒë·ªïi
              </li>
              <li>‚Ä¢ Nh·∫•n "Xu·∫•t Excel" ƒë·ªÉ t·∫£i file CSV</li>
            </ul>
          </div>
        </div>
      </main>
    </div>

    <script>
      function dutySchedule() {
        return {
          currentUser: {},
          currentWeekStart: null,
          weekDays: [],
          allUsers: [],
          commanders: ["V≈©", "Tu·∫•n", "Qu√¢n", "Ph√°t"],
          editingCell: null,
          searchQuery: "",

          init() {
            const session = localStorage.getItem("dqp10_session");
            if (!session) {
              window.location.href = "login.html";
              return;
            }
            this.currentUser = JSON.parse(session);
            this.loadUsers();
            this.currentWeekStart = this.getMonday(new Date());
            this.loadSchedule();
          },

          loadUsers() {
            const stored = localStorage.getItem("dqp10_users");
            if (stored) {
              this.allUsers = JSON.parse(stored);
            } else {
              // If no users in localStorage, create default list and save it
              this.allUsers = [
                // T·ªï 1
                { name: "Ng√¥ Tr∆∞∆°ng ƒê·ªãnh", team: "T·ªï 1" },
                { name: "Ng√¥ Ho√†i B·∫£o", team: "T·ªï 1" },
                { name: "Nguy·ªÖn L√Ω Minh Quang", team: "T·ªï 1" },
                { name: "Nguy·ªÖn Th√†nh T√†i", team: "T·ªï 1" },
                // T·ªï 2
                { name: "L√Ω Tri·ªáu An", team: "T·ªï 2" },
                { name: "Ph·∫°m Gia B·∫£o", team: "T·ªï 2" },
                { name: "L√¢m Ng·ªçc Huy·ªÅn", team: "T·ªï 2" },
                { name: "ƒêo√†n Qu·ªëc ƒê·∫°t", team: "T·ªï 2" },
                { name: "Nguy·ªÖn Thanh Nh√¢n", team: "T·ªï 2" },
                // T·ªï 3
                { name: "Phan Phong Ph√∫", team: "T·ªï 3" },
                { name: "Tr∆∞∆°ng Giang Minh T√πng", team: "T·ªï 3" },
                { name: "L∆∞∆°ng Tri·ªáu Ph√°t", team: "T·ªï 3" },
                { name: "Nguy·ªÖn T·∫•n Thu·∫≠n", team: "T·ªï 3" },
                { name: "Nguy·ªÖn Ng·ªçc Ti·∫øn", team: "T·ªï 3" },
                // T·ªï 4
                { name: "L·∫°i Tu Trung", team: "T·ªï 4" },
                { name: "Ki·ªÅu Gia Huy", team: "T·ªï 4" },
                { name: "L√¢m Ng·ªçc Y·∫øn", team: "T·ªï 4" },
                { name: "Tr·∫ßn Minh Hi·∫øu", team: "T·ªï 4" },
                // T·ªï 5
                { name: "V√µ C√¥ng Minh", team: "T·ªï 5" },
                { name: "V√µ Tr·∫ßn Vinh", team: "T·ªï 5" },
                { name: "Nguy·ªÖn ƒêƒÉng ƒê√¥ng", team: "T·ªï 5" },
                { name: "L√™ Minh Ho√†ng", team: "T·ªï 5" },
                // T·ªï 6
                { name: "Tr·∫ßn Ho√†ng Phi", team: "T·ªï 6" },
                { name: "L∆∞u Vƒ©nh C∆°", team: "T·ªï 6" },
                { name: "L√™ H·∫£i Tri·ªÅu", team: "T·ªï 6" },
                { name: "Ho√†ng Ph·∫°m Th·∫ø L·ªôc", team: "T·ªï 6" },
                { name: "V∆∞∆°ng Qu√Ω Th·∫Øng", team: "T·ªï 6" },
                // T·ªï 7
                { name: "La Gia Huy", team: "T·ªï 7" },
                { name: "Nguy·ªÖn Trung Ki√™n", team: "T·ªï 7" },
                { name: "Nguy·ªÖn Ng·ªçc S∆°n", team: "T·ªï 7" },
                { name: "Tr·∫ßn Anh Tu·∫•n", team: "T·ªï 7" },
                // T·ªï 8
                { name: "Tr∆∞∆°ng T·∫•n Kh∆∞∆°ng", team: "T·ªï 8" },
                { name: "Nguy·ªÖn Ng√¥ Ho√†ng Ph∆∞∆°ng", team: "T·ªï 8" },
                { name: "ƒê·∫∑ng Trung H·∫£o", team: "T·ªï 8" },
                { name: "L√™ Gia Tri·∫øt", team: "T·ªï 8" },
                // T·ªï 9
                { name: "Cao Thanh Long", team: "T·ªï 9" },
                { name: "L√™ Hu·ª≥nh √Åi Nhi", team: "T·ªï 9" },
                { name: "Nguy·ªÖn Anh Chi·∫øn", team: "T·ªï 9" },
                { name: "H√† Thanh Huy", team: "T·ªï 9" },
              ];
              localStorage.setItem(
                "dqp10_users",
                JSON.stringify(this.allUsers),
              );
            }
          },

          getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
          },

          loadSchedule() {
            const weekKey = this.getWeekKey();
            const saved = localStorage.getItem(`dqp10_schedule_${weekKey}`);

            if (saved) {
              this.weekDays = JSON.parse(saved);
            } else {
              this.generateSchedule();
            }
          },

          generateSchedule() {
            this.weekDays = [];
            const dayNames = [
              "Th·ª© 2",
              "Th·ª© 3",
              "Th·ª© 4",
              "Th·ª© 5",
              "Th·ª© 6",
              "Th·ª© 7",
              "Ch·ªß nh·∫≠t",
            ];

            // Calculate base day index from epoch for consistent rotation
            const epochStart = new Date(2026, 0, 20); // 20/01/2026 (Monday)
            const daysSinceEpoch = Math.floor(
              (this.currentWeekStart - epochStart) / (1000 * 60 * 60 * 24),
            );

            for (let i = 0; i < 7; i++) {
              const date = new Date(this.currentWeekStart);
              date.setDate(date.getDate() + i);

              // Commander rotates DAILY (not weekly)
              const absoluteDayIndex = daysSinceEpoch + i;
              const commanderIdx = absoluteDayIndex % 4;

              // DQCD rotation: A1+A13, A2+A14, ..., A12+A24, then repeat
              const dqcdIdx = absoluteDayIndex % 12; // 0-11
              const dqcdFirst = `A${dqcdIdx + 1}`;
              const dqcdSecond = `A${dqcdIdx + 13}`;

              this.weekDays.push({
                date: date.toISOString(),
                dayName: dayNames[i],
                dateStr: `${String(date.getDate()).padStart(2, "0")}/${String(date.getMonth() + 1).padStart(2, "0")}`,
                trucChiHuy: this.commanders[commanderIdx],
                trucBan: this.getRandomUser(),
                trucCongVan: this.getRandomUser(),
                trucNoiVu: this.getRandomUser(),
                trucCom: this.getRandomUser(),
                trucTruSo: this.getRandomUser(),
                dqttPhuTrach: this.getRandomUser(),
                dqcdTruc: `${dqcdFirst}, ${dqcdSecond}`,
              });
            }
          },

          getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
          },

          getRandomUser() {
            return this.allUsers[
              Math.floor(Math.random() * this.allUsers.length)
            ].name;
          },

          getWeekKey() {
            return `${this.currentWeekStart.getFullYear()}-W${this.getWeekNumber(this.currentWeekStart)}`;
          },

          get currentWeekText() {
            const end = new Date(this.currentWeekStart);
            end.setDate(end.getDate() + 6);
            return `Tu·∫ßn ${this.getWeekNumber(this.currentWeekStart)}: ${this.formatDate(this.currentWeekStart)} - ${this.formatDate(end)}`;
          },

          formatDate(date) {
            return `${String(date.getDate()).padStart(2, "0")}/${String(date.getMonth() + 1).padStart(2, "0")}/${date.getFullYear()}`;
          },

          get isEditable() {
            return this.currentUser.role === "admin";
          },

          get filteredUsers() {
            if (!this.searchQuery) return this.allUsers;
            return this.allUsers.filter((user) =>
              user.name.toLowerCase().includes(this.searchQuery.toLowerCase()),
            );
          },

          handleCellClick(dayIdx, field) {
            if (!this.isEditable) return;
            this.editingCell = { dayIdx, field };
            this.searchQuery = "";
          },

          selectUser(userName) {
            if (!this.editingCell) return;
            const { dayIdx, field } = this.editingCell;
            this.weekDays[dayIdx][field] = userName;
            this.editingCell = null;
            this.searchQuery = "";
          },

          saveSchedule() {
            const weekKey = this.getWeekKey();
            localStorage.setItem(
              `dqp10_schedule_${weekKey}`,
              JSON.stringify(this.weekDays),
            );
            alert("‚úÖ ƒê√£ l∆∞u l·ªãch tr·ª±c!");
          },

          previousWeek() {
            this.currentWeekStart.setDate(this.currentWeekStart.getDate() - 7);
            this.currentWeekStart = new Date(this.currentWeekStart);
            this.loadSchedule();
          },

          nextWeek() {
            this.currentWeekStart.setDate(this.currentWeekStart.getDate() + 7);
            this.currentWeekStart = new Date(this.currentWeekStart);
            this.loadSchedule();
          },

          exportExcel() {
            let csv =
              "Th·ª©/Ng√†y,Tr·ª±c ch·ªâ huy,Tr·ª±c ban,Tr·ª±c c√¥ng vƒÉn,Tr·ª±c n·ªôi v·ª•,Tr·ª±c c∆°m,Tr·ª±c tr·ª• s·ªü HƒêND - UBND; ƒê·∫£ng ·ªßy,DQTT ph·ª• tr√°ch A,DQCD Tr·ª±c - Tu·∫ßn tra\n";

            this.weekDays.forEach((day) => {
              csv += `"${day.dayName} (${day.dateStr})","${day.trucChiHuy}","${day.trucBan}","${day.trucCongVan}","${day.trucNoiVu}","${day.trucCom}","${day.trucTruSo}","${day.dqttPhuTrach}","${day.dqcdTruc}"\n`;
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `lich-truc-${this.getWeekKey()}.csv`;
            link.click();

            alert("‚úÖ ƒê√£ xu·∫•t file CSV!");
          },

          logout() {
            localStorage.removeItem("dqp10_session");
            window.location.href = "login.html";
          },
        };
      }
    </script>
  </body>
</html>
