<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đăng nhập - Dân quân Phường Bình Phú</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              olive: "#556B2F",
            },
          },
        },
      };
    </script>
  </head>

  <body class="bg-gray-50 font-sans antialiased">
    <div
      class="min-h-screen flex items-center justify-center p-4"
      x-data="loginApp()"
    >
      <!-- Login Card -->
      <div class="w-full max-w-md">
        <!-- Logo & Title -->
        <div class="text-center mb-8">
          <img
            src="logo-dqtv.png"
            alt="Logo Dân quân Tự vệ"
            class="size-24 object-contain mb-4 mx-auto"
          />
          <h1 class="text-3xl font-bold text-gray-900">Dân Quân Tự Vệ</h1>
          <p class="text-gray-600 mt-2">BAN CHQS PHƯỜNG BÌNH PHÚ</p>
        </div>

        <!-- Login Form -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
          <!-- Error Message -->
          <div
            x-show="errorMessage"
            x-cloak
            class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start gap-2"
          >
            <span class="material-symbols-outlined text-red-600 text-xl"
              >error</span
            >
            <p class="text-sm text-red-700 flex-1" x-text="errorMessage"></p>
          </div>

          <!-- Success Message -->
          <div
            x-show="successMessage"
            x-cloak
            class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-start gap-2"
          >
            <span class="material-symbols-outlined text-green-600 text-xl"
              >check_circle</span
            >
            <p
              class="text-sm text-green-700 flex-1"
              x-text="successMessage"
            ></p>
          </div>

          <form @submit.prevent="handleLogin">
            <!-- Username -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Tên đăng nhập
              </label>
              <div class="relative">
                <span
                  class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                  >person</span
                >
                <input
                  x-model="username"
                  type="text"
                  required
                  autofocus
                  class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive focus:border-transparent"
                  placeholder="Nhập tên đăng nhập"
                />
              </div>
            </div>

            <!-- Password -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Mật khẩu
              </label>
              <div class="relative">
                <span
                  class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                  >lock</span
                >
                <input
                  x-model="password"
                  :type="showPassword ? 'text' : 'password'"
                  required
                  class="w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive focus:border-transparent"
                  placeholder="Nhập mật khẩu"
                />
                <button
                  type="button"
                  @click="showPassword = !showPassword"
                  class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                >
                  <span
                    x-text="showPassword ? 'visibility_off' : 'visibility'"
                  ></span>
                </button>
              </div>
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              :disabled="loading"
              class="w-full bg-olive text-white py-3 px-4 rounded-lg font-semibold hover:bg-olive/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              <span x-show="loading" class="inline-block animate-spin">⏳</span>
              <span x-text="loading ? 'Đang đăng nhập...' : 'Đăng nhập'"></span>
            </button>
          </form>
        </div>

        <!-- Footer -->
        <p class="text-center text-sm text-gray-500 mt-6">
          © 2026 Phường đội Bình Phú
        </p>
      </div>
    </div>

    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>

    <!-- Load sample data -->
    <script src="sample-data.js"></script>
    <script>
      function loginApp() {
        return {
          username: "",
          password: "",
          showPassword: false,
          loading: false,
          errorMessage: "",
          successMessage: "",

          init() {
            // Check if already logged in
            const session = localStorage.getItem("dqp10_session");
            if (session) {
              window.location.href = "activity-calendar.html";
              return;
            }

            // Initialize demo accounts
            this.initializeAccounts();
          },

          initializeAccounts() {
            const existingAccounts = localStorage.getItem("dqp10_accounts");
            if (!existingAccounts) {
              const accounts = [
                {
                  username: "ntnhan",
                  password: "123456",
                  role: "user",
                  fullName: "Nguyễn Thanh Nhân",
                  team: "Tổ 2",
                },
                {
                  username: "ppphu",
                  password: "123456",
                  role: "user",
                  fullName: "Phan Phong Phú",
                  team: "Tổ 3",
                },
                {
                  username: "admin",
                  password: "admin123",
                  role: "admin",
                  fullName: "Administrator",
                  team: null,
                },
              ];
              localStorage.setItem("dqp10_accounts", JSON.stringify(accounts));
            }
          },

          // Load sample data nếu chưa có trong localStorage
          loadSampleData() {
            const existingActivities = localStorage.getItem("dqp10_activities");
            const existingUsers = localStorage.getItem("dqp10_users");

            if (!existingActivities || !existingUsers) {
              try {
                // sampleActivities và dqp10_users được định nghĩa trong sample-data.js
                if (typeof sampleActivities !== "undefined") {
                  localStorage.setItem(
                    "dqp10_activities",
                    JSON.stringify(sampleActivities),
                  );
                  console.log("✅ Đã load sample activities vào localStorage");
                }
                if (typeof dqp10_users !== "undefined") {
                  localStorage.setItem(
                    "dqp10_users",
                    JSON.stringify(dqp10_users),
                  );
                  console.log("✅ Đã load sample users vào localStorage");
                }
                return true; // Đã load data mới
              } catch (error) {
                console.error("❌ Lỗi khi load sample data:", error);
                return false;
              }
            }
            return false; // Data đã tồn tại
          },

          // Migrate activities: thêm status cho mỗi task nếu chưa có
          migrateActivities() {
            const data = localStorage.getItem("dqp10_activities");
            if (!data) return;

            try {
              const activities = JSON.parse(data);
              let updatedTasks = 0;

              activities.forEach((activity) => {
                // Remove activity-level status nếu có
                if (activity.status) {
                  delete activity.status;
                }

                // Add status to each task
                if (activity.tasks && Array.isArray(activity.tasks)) {
                  activity.tasks.forEach((task) => {
                    if (!task.status) {
                      // If task is already completed, set status to Hoàn thành
                      if (task.completed) {
                        task.status = "Hoàn thành";
                      } else {
                        // Default status for new tasks
                        task.status = "Chờ nhận nhiệm vụ";
                      }
                      updatedTasks++;
                    }
                  });
                }
              });

              // Save back to localStorage
              localStorage.setItem(
                "dqp10_activities",
                JSON.stringify(activities),
              );
              if (updatedTasks > 0) {
                console.log(
                  `✅ Migration: Đã cập nhật status cho ${updatedTasks} tasks`,
                );
              }
            } catch (error) {
              console.error("❌ Lỗi khi migrate activities:", error);
            }
          },

          async handleLogin() {
            this.errorMessage = "";
            this.successMessage = "";

            // Validation
            if (!this.username || !this.password) {
              this.errorMessage = "Vui lòng nhập đầy đủ thông tin!";
              return;
            }

            this.loading = true;

            // Simulate API delay
            await new Promise((resolve) => setTimeout(resolve, 800));

            // Get accounts from localStorage
            const accounts = JSON.parse(
              localStorage.getItem("dqp10_accounts") || "[]",
            );

            // Find matching account
            const account = accounts.find(
              (acc) =>
                acc.username === this.username &&
                acc.password === this.password,
            );

            if (account) {
              // Login successful
              this.successMessage = `Đăng nhập thành công! Xin chào ${account.fullName}`;

              // Create session
              const session = {
                username: account.username,
                fullName: account.fullName,
                role: account.role,
                team: account.team,
                loginTime: new Date().toISOString(),
              };
              localStorage.setItem("dqp10_session", JSON.stringify(session));

              // Load sample data nếu chưa có
              this.loadSampleData();

              // Migrate activities để đảm bảo tasks có status
              this.migrateActivities();

              // Redirect to dashboard
              setTimeout(() => {
                window.location.href = "activity-calendar.html";
              }, 1000);
            } else {
              // Login failed
              this.errorMessage = "Tên đăng nhập hoặc mật khẩu không đúng!";
              this.loading = false;
            }
          },
        };
      }
    </script>
  </body>
</html>
