<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Danh sách Kế hoạch - Dân quân Phường Bình Phú</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="notification-system.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { olive: "#556B2F" },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-50 font-sans antialiased">
    <div class="flex h-screen overflow-hidden" x-data="listApp()">
      <!-- Sidebar -->
      <aside
        class="w-64 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col p-4 hidden md:flex h-full"
      >
        <div class="flex gap-3 px-2 py-2 mb-4">
          <img src="logo-dqtv.png" alt="Logo" class="size-10 object-contain" />
          <div class="flex flex-col justify-center">
            <h1 class="text-gray-900 text-base font-bold">
              BAN CHQS PHƯỜNG BÌNH PHÚ
            </h1>
            <p class="text-gray-500 text-xs">Hệ thống quản lý</p>
          </div>
        </div>

        <!-- User Profile -->
        <div
          class="mb-4 p-3 bg-gradient-to-r from-olive/10 to-olive/5 rounded-lg border border-olive/20"
        >
          <div class="flex items-center gap-2">
            <div class="relative">
              <div
                class="size-10 rounded-full bg-olive/20 flex items-center justify-center"
              >
                <span class="material-symbols-outlined text-olive text-2xl"
                  >account_circle</span
                >
              </div>
              <span
                class="absolute bottom-0 right-0 size-3 bg-green-500 border-2 border-white rounded-full"
              ></span>
            </div>
            <div class="flex-1 min-w-0">
              <p
                class="text-sm font-bold text-gray-900 truncate"
                x-text="currentUser.fullName || 'Guest'"
              ></p>
              <p class="text-xs text-gray-600">
                <span
                  class="px-2 py-0.5 rounded-full text-xs font-medium"
                  :class="{'bg-blue-100 text-blue-700': currentUser.role === 'dqtt', 'bg-orange-100 text-orange-700': currentUser.role === 'admin'}"
                  x-text="currentUser.role === 'admin' ? 'Admin' : (currentUser.team || 'DQTT')"
                ></span>
              </p>
            </div>
          </div>
        </div>

        <nav class="flex flex-col gap-2">
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="index.html"
          >
            <span class="material-symbols-outlined text-gray-600">home</span>
            <p class="text-sm font-medium text-gray-600">Trang chủ</p>
          </a>
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="dashboard-tong-hop.html"
          >
            <span class="material-symbols-outlined text-gray-600"
              >assessment</span
            >
            <p class="text-sm font-medium text-gray-600">Dashboard</p>
          </a>
          <div>
            <div class="flex items-center gap-3 px-3 py-2 text-gray-700">
              <span class="material-symbols-outlined text-gray-600">event</span>
              <p class="text-sm font-bold text-gray-700">Hoạt động</p>
            </div>
            <div class="ml-6 space-y-1 border-l-2 border-gray-200 pl-3">
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-olive/10 text-olive"
                href="activity-list.html"
              >
                <span class="size-1.5 rounded-full bg-olive"></span>
                <p class="text-sm font-bold">Danh sách</p>
              </a>
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="activity-calendar.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">Lịch</p>
              </a>
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="module-lich-truc.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">Lịch trực</p>
              </a>
            </div>
          </div>
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="module2-personnel-complete.html"
          >
            <span class="material-symbols-outlined text-gray-600">group</span>
            <p class="text-sm font-medium text-gray-600">Nhân sự</p>
          </a>
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="module3-inventory-complete.html"
          >
            <span class="material-symbols-outlined text-gray-600"
              >inventory_2</span
            >
            <p class="text-sm font-medium text-gray-600">Kho</p>
          </a>
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="module4-documents-complete.html"
          >
            <span class="material-symbols-outlined text-gray-600">folder</span>
            <p class="text-sm font-medium text-gray-600">Tài liệu</p>
          </a>
        </nav>

        <div class="mt-auto pt-4 border-t border-gray-200 space-y-2">
          <a
            @click.prevent="logout()"
            href="#"
            class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-bold bg-olive text-white hover:bg-olive/90 transition-colors justify-center cursor-pointer"
          >
            <span class="material-symbols-outlined text-xl">logout</span>
            <span>Đăng xuất</span>
          </a>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold text-gray-900">
                Danh sách Kế hoạch
              </h1>
              <p class="text-sm text-gray-500 mt-1">
                Quản lý và theo dõi các kế hoạch hoạt động
              </p>
            </div>
            <div class="flex items-center gap-3">
              <!-- Notification Bell System -->
              <div x-data="notificationBell" class="relative">
                <!-- Bell Button -->
                <button
                  @click="toggleDropdown()"
                  class="relative p-2 hover:bg-gray-100 rounded-lg transition-colors"
                  :class="{'bg-gray-100': isOpen}"
                >
                  <span class="material-symbols-outlined">notifications</span>

                  <span
                    x-show="unreadCount > 0"
                    class="absolute top-2 right-2 size-2 bg-red-500 rounded-full"
                  ></span>

                  <span
                    x-show="unreadCount > 0"
                    class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full px-1.5 py-0.5 min-w-[20px] text-center"
                    x-text="unreadCount"
                  ></span>
                </button>

                <!-- Dropdown Panel -->
                <div
                  x-show="isOpen"
                  @click.away="isOpen = false"
                  class="absolute right-0 mt-2 w-96 bg-white rounded-xl shadow-2xl border border-gray-200 z-50"
                  style="display: none"
                  x-cloak
                >
                  <div
                    class="px-4 py-3 border-b border-gray-200 flex items-center justify-between"
                  >
                    <h3 class="text-sm font-bold text-gray-900">
                      Thông báo nhiệm vụ
                    </h3>
                    <span
                      class="text-xs text-gray-500"
                      x-text="notifications.length + ' nhiệm vụ'"
                    ></span>
                  </div>

                  <div class="max-h-96 overflow-y-auto">
                    <template x-if="notifications.length === 0">
                      <div class="p-8 text-center">
                        <span
                          class="material-symbols-outlined text-4xl text-gray-300"
                          >notifications_off</span
                        >
                        <p class="text-sm text-gray-500 mt-2">
                          Không có thông báo mới
                        </p>
                      </div>
                    </template>

                    <div class="divide-y divide-gray-100">
                      <template x-for="notif in notifications" :key="notif.id">
                        <div class="p-4 hover:bg-gray-50 transition-colors">
                          <div class="flex items-start gap-3">
                            <div
                              class="bg-yellow-100 rounded-lg p-2 flex-shrink-0"
                            >
                              <span
                                class="material-symbols-outlined text-yellow-600 text-xl"
                                >assignment</span
                              >
                            </div>

                            <div class="flex-1 min-w-0">
                              <p
                                class="text-sm font-semibold text-gray-900 mb-1"
                                x-text="notif.taskName"
                              ></p>

                              <div class="space-y-1 mb-2">
                                <p
                                  class="text-xs text-gray-600 flex items-center gap-1"
                                >
                                  <span
                                    class="material-symbols-outlined text-[14px]"
                                    >location_on</span
                                  >
                                  <span x-text="notif.location"></span>
                                </p>
                                <p
                                  class="text-xs text-gray-600 flex items-center gap-1"
                                >
                                  <span
                                    class="material-symbols-outlined text-[14px]"
                                    >schedule</span
                                  >
                                  <span
                                    >Thời hạn:
                                    <span x-text="notif.deadline"></span
                                  ></span>
                                </p>
                              </div>

                              <div class="flex gap-2">
                                <a
                                  :href="'activity-detail.html?id=' + notif.activityId"
                                  class="text-xs text-olive hover:underline font-medium"
                                >
                                  Xem chi tiết
                                </a>
                                <button
                                  @click="confirmRead(notif.id)"
                                  class="text-xs text-blue-600 hover:underline font-medium"
                                >
                                  Xác nhận đã đọc
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>

                  <div
                    x-show="notifications.length > 0"
                    class="px-4 py-3 border-t border-gray-200 bg-gray-50"
                  >
                    <button
                      @click="markAllRead()"
                      class="text-xs text-olive hover:underline font-medium w-full text-center"
                    >
                      Đánh dấu tất cả đã đọc
                    </button>
                  </div>
                </div>
              </div>

              <a
                href="create-activity.html"
                class="flex items-center gap-2 px-4 py-2 bg-olive text-white rounded-lg hover:bg-olive/90 transition-colors"
              >
                <span class="material-symbols-outlined">add</span>
                <span class="font-semibold">Tạo kế hoạch</span>
              </a>
            </div>
          </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6">
          <!-- Status Filter -->
          <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6">
            <div class="flex flex-wrap items-center gap-4">
              <span class="text-sm font-semibold text-gray-700"
                >Lọc theo trạng thái:</span
              >

              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  x-model="statusFilters.notStarted"
                  @change="applyStatusFilter()"
                  class="w-4 h-4 rounded border-gray-300 text-yellow-600 focus:ring-yellow-500"
                />
                <span
                  class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700 border border-yellow-200"
                >
                  <span class="size-2 rounded-full bg-yellow-600"></span>
                  Chưa bắt đầu
                </span>
              </label>

              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  x-model="statusFilters.inProgress"
                  @change="applyStatusFilter()"
                  class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                />
                <span
                  class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200"
                >
                  <span class="size-2 rounded-full bg-blue-600"></span>
                  Đang thực hiện
                </span>
              </label>

              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  x-model="statusFilters.completed"
                  @change="applyStatusFilter()"
                  class="w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500"
                />
                <span
                  class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-200"
                >
                  <span class="size-2 rounded-full bg-green-600"></span>
                  Hoàn thành
                </span>
              </label>
            </div>
          </div>

          <!-- Empty state -->
          <div
            x-show="filteredActivities.length === 0"
            x-cloak
            class="text-center py-12"
          >
            <span class="material-symbols-outlined text-gray-400 text-6xl"
              >event_busy</span
            >
            <p class="text-gray-500 mt-4 text-lg">Không có kế hoạch nào</p>
          </div>

          <!-- Activity Cards Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="activity in filteredActivities" :key="activity.id">
              <a
                :href="`activity-detail.html?id=${activity.id}`"
                class="block bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-all"
              >
                <div class="p-5">
                  <!-- Header -->
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex-1 pr-2">
                      <h3
                        class="text-lg font-bold text-gray-900 mb-1 line-clamp-2"
                        x-text="activity.name"
                      ></h3>
                      <div
                        class="flex items-center gap-4 text-sm text-gray-500"
                      >
                        <div class="flex items-center gap-1">
                          <span class="material-symbols-outlined text-sm"
                            >calendar_today</span
                          >
                          <span
                            x-text="`${activity.startDate} - ${activity.endDate}`"
                          ></span>
                        </div>
                      </div>
                    </div>
                    <div class="flex flex-col gap-1 items-end">
                      <div
                        class="flex items-center gap-1.5 px-3 py-1 rounded-full whitespace-nowrap"
                        :class="getStatusColor(getActivityStatus(activity))"
                      >
                        <span
                          class="size-2 rounded-full bg-current opacity-70"
                        ></span>
                        <span
                          class="text-xs font-bold uppercase"
                          x-text="getActivityStatus(activity)"
                        ></span>
                      </div>
                      <span
                        x-show="isOverdue(activity)"
                        class="inline-flex items-center gap-1 px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full font-medium border border-red-200"
                      >
                        <span class="material-symbols-outlined text-xs"
                          >warning</span
                        >
                        Quá hạn
                      </span>
                    </div>
                  </div>

                  <!-- Tags -->
                  <div class="flex items-center gap-2 flex-wrap mb-3">
                    <span
                      class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-medium"
                    >
                      <span class="material-symbols-outlined text-sm"
                        >school</span
                      >
                      <span x-text="activity.workGroup"></span>
                    </span>
                    <span
                      class="inline-flex items-center gap-1 px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full font-medium"
                    >
                      <span class="material-symbols-outlined text-sm"
                        >group</span
                      >
                      <span x-text="`Tổ ${activity.department}`"></span>
                    </span>
                    <span
                      x-show="activity.location"
                      class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full font-medium"
                    >
                      <span class="material-symbols-outlined text-sm"
                        >location_on</span
                      >
                      <span x-text="activity.location"></span>
                    </span>
                  </div>

                  <!-- Progress Bar -->
                  <div class="mb-3">
                    <div class="flex items-center justify-between text-sm mb-1">
                      <span class="text-gray-600">Tiến độ</span>
                      <span
                        class="font-bold text-olive"
                        x-text="`${getProgress(activity)}%`"
                      ></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                      <div
                        class="h-2 rounded-full transition-all"
                        :class="getProgress(activity) === 100 ? 'bg-green-500' : 'bg-olive'"
                        :style="`width: ${getProgress(activity)}%`"
                      ></div>
                    </div>
                  </div>

                  <!-- Tasks Summary -->
                  <div
                    class="flex items-center justify-between pt-3 border-t border-gray-100"
                  >
                    <div class="flex items-center gap-4 text-sm text-gray-600">
                      <div class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm"
                          >task</span
                        >
                        <span
                          x-text="`${activity.tasks.length} nhiệm vụ`"
                        ></span>
                      </div>
                      <div
                        x-show="activity.documentNumber"
                        class="flex items-center gap-1"
                      >
                        <span class="material-symbols-outlined text-sm"
                          >description</span
                        >
                        <span x-text="activity.documentNumber"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </a>
            </template>
          </div>
        </div>
      </main>
    </div>

    <script>
      function listApp() {
        return {
          currentUser: { fullName: "Guest", role: null, team: null },
          activities: [],
          filteredActivities: [],
          statusFilters: {
            notStarted: false, // Chưa bắt đầu
            inProgress: true, // Đang thực hiện - default checked
            completed: true, // Hoàn thành - default checked
          },

          init() {
            const session = localStorage.getItem("dqp10_session");
            if (!session) {
              window.location.href = "login.html";
              return;
            }
            this.currentUser = JSON.parse(session);
            this.loadActivities();
          },

          loadActivities() {
            const data = localStorage.getItem("dqp10_activities");
            if (data) {
              this.activities = JSON.parse(data);
              if (this.currentUser.role === "admin") {
                this.applyStatusFilter();
              } else {
                const teamNumber = this.currentUser.team
                  ? this.currentUser.team.replace("Tổ ", "")
                  : null;
                if (teamNumber) {
                  const teamActivities = this.activities.filter(
                    (a) => a.department === teamNumber,
                  );
                  this.applyStatusFilterTo(teamActivities);
                } else {
                  this.applyStatusFilter();
                }
              }
            }
          },

          applyStatusFilter() {
            this.applyStatusFilterTo(this.activities);
          },

          applyStatusFilterTo(activities) {
            // Apply status filter
            const selectedStatuses = [];
            if (this.statusFilters.notStarted)
              selectedStatuses.push("Chưa bắt đầu");
            if (this.statusFilters.inProgress)
              selectedStatuses.push("Đang thực hiện");
            if (this.statusFilters.completed)
              selectedStatuses.push("Hoàn thành");

            if (selectedStatuses.length === 0) {
              this.filteredActivities = [];
            } else {
              this.filteredActivities = activities.filter((a) => {
                const status = this.getActivityStatus(a);
                return selectedStatuses.includes(status);
              });
            }
          },

          getProgress(activity) {
            if (!activity.tasks || activity.tasks.length === 0) return 0;
            const completed = activity.tasks.filter((t) => t.completed).length;
            return Math.round((completed / activity.tasks.length) * 100);
          },

          getActivityStatus(activity) {
            // Calculate activity status based on task completion
            if (!activity.tasks || activity.tasks.length === 0)
              return "Chưa bắt đầu";

            const completed = activity.tasks.filter((t) => t.completed).length;
            if (completed === 0) return "Chưa bắt đầu";
            if (completed === activity.tasks.length) return "Hoàn thành";
            return "Đang thực hiện";
          },

          isOverdue(activity) {
            const parseDate = (dateStr) => {
              const [day, month, year] = dateStr.split("/");
              return new Date(year, month - 1, day);
            };
            const endDate = parseDate(activity.endDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return (
              endDate < today &&
              this.getActivityStatus(activity) !== "Hoàn thành"
            );
          },

          getStatusColor(status) {
            if (status === "Hoàn thành")
              return "bg-green-100 text-green-700 border border-green-200";
            if (status === "Đang thực hiện")
              return "bg-blue-100 text-blue-700 border border-blue-200";
            if (status === "Chưa bắt đầu")
              return "bg-yellow-100 text-yellow-700 border border-yellow-200";
            return "bg-gray-100 text-gray-700 border border-gray-200";
          },

          logout() {
            localStorage.removeItem("dqp10_session");
            window.location.href = "login.html";
          },
        };
      }
    </script>

    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>
  </body>
</html>
