<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt Ho·∫°t ƒë·ªông - D√¢n qu√¢n Ph∆∞·ªùng B√¨nh Ph√∫</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="notification-system.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { olive: "#556B2F" },
          },
        },
      };
    </script>
  </head>
  <body
    class="bg-gray-50 font-sans antialiased"
    x-data="activityDetail()"
    x-init="init()"
  >
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside
        class="w-64 flex-shrink-0 bg-white border-r border-gray-200 p-4 hidden md:flex flex-col"
      >
        <div class="flex gap-3 px-2 py-2 mb-6">
          <img src="logo-dqtv.png" alt="Logo" class="size-10 object-contain" />
          <div class="flex flex-col justify-center">
            <h1 class="text-gray-900 text-base font-bold">
              Ph∆∞·ªùng ƒë·ªôi B√¨nh Ph√∫
            </h1>
            <p class="text-gray-500 text-xs">H·ªá th·ªëng qu·∫£n l√Ω</p>
          </div>
        </div>

        <!-- User Profile Card -->
        <div
          class="bg-gradient-to-r from-olive/10 to-olive/5 rounded-xl p-3 mb-4 border border-olive/20"
        >
          <div class="flex items-center gap-3">
            <div class="relative">
              <div
                class="bg-olive/20 rounded-full size-10 flex items-center justify-center"
              >
                <span class="material-symbols-outlined text-olive text-lg"
                  >person</span
                >
              </div>
              <span
                class="absolute bottom-0 right-0 size-2.5 bg-green-500 rounded-full border-2 border-white"
              ></span>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-bold text-gray-900 truncate">
                Nguy·ªÖn VƒÉn Quang
              </p>
              <p class="text-xs text-gray-600">DQTT</p>
            </div>
          </div>
        </div>

        <nav class="flex flex-col gap-2">
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="index.html"
          >
            <span class="material-symbols-outlined text-gray-600">home</span>
            <p class="text-sm font-medium text-gray-600">Trang ch·ªß</p>
          </a>
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg bg-olive/10 text-olive"
            href="activity-list.html"
          >
            <span class="material-symbols-outlined">event</span>
            <p class="text-sm font-bold">Ho·∫°t ƒë·ªông</p>
          </a>

          <!-- Nh√¢n s·ª± with submenu -->
          <div>
            <div class="flex items-center gap-3 px-3 py-2 text-gray-700">
              <span class="material-symbols-outlined text-gray-600">group</span>
              <p class="text-sm font-bold text-gray-700">Nh√¢n s·ª±</p>
            </div>
            <div class="ml-6 space-y-1 border-l-2 border-gray-200 pl-3">
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="personnel-tuoi17.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">Tu·ªïi 17</p>
              </a>
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="personnel-nguon.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">Ngu·ªìn</p>
              </a>
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="personnel-qndb.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">Qu√¢n nh√¢n d·ª± b·ªã</p>
              </a>
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="personnel-dqtt.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">DQTT</p>
              </a>
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="personnel-dqcd.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">DQCƒê</p>
              </a>
            </div>
          </div>

          <!-- Kho -->
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="module3-inventory-complete.html"
          >
            <span class="material-symbols-outlined text-gray-600"
              >inventory_2</span
            >
            <p class="text-sm font-medium text-gray-600">Kho</p>
          </a>

          <!-- T√†i li·ªáu -->
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="module4-documents-complete.html"
          >
            <span class="material-symbols-outlined text-gray-600">folder</span>
            <p class="text-sm font-medium text-gray-600">T√†i li·ªáu</p>
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h1
                class="text-2xl font-bold text-gray-900"
                x-text="activity?.name || 'Loading...'"
              ></h1>
              <div class="flex items-center gap-3 mt-2" x-show="activity">
                <span
                  class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full"
                  x-text="activity?.workGroup"
                ></span>
                <span
                  class="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded-full"
                  x-text="`T·ªï ${activity?.department}`"
                ></span>
                <span
                  x-show="activity?.location"
                  class="px-3 py-1 bg-purple-100 text-purple-700 text-xs font-medium rounded-full"
                  x-text="activity?.location"
                ></span>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <!-- Notification Bell System -->
              <div x-data="notificationBell" class="relative">
                <!-- Bell Button -->
                <button
                  @click="toggleDropdown()"
                  class="relative p-2 hover:bg-gray-100 rounded-lg transition-colors"
                  :class="{'bg-gray-100': isOpen}"
                >
                  <span class="material-symbols-outlined">notifications</span>
                  <span
                    x-show="unreadCount > 0"
                    class="absolute top-2 right-2 size-2 bg-red-500 rounded-full"
                  ></span>
                  <span
                    x-show="unreadCount > 0"
                    class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full px-1.5 py-0.5 min-w-[20px] text-center"
                    x-text="unreadCount"
                  ></span>
                </button>

                <!-- Dropdown Panel -->
                <div
                  x-show="isOpen"
                  @click.away="isOpen = false"
                  class="absolute right-0 mt-2 w-96 bg-white rounded-xl shadow-2xl border border-gray-200 z-50"
                  style="display: none"
                  x-cloak
                >
                  <div
                    class="px-4 py-3 border-b border-gray-200 flex items-center justify-between"
                  >
                    <h3 class="text-sm font-bold text-gray-900">
                      Th√¥ng b√°o nhi·ªám v·ª•
                    </h3>
                    <span
                      class="text-xs text-gray-500"
                      x-text="notifications.length + ' nhi·ªám v·ª•'"
                    ></span>
                  </div>
                  <div class="max-h-96 overflow-y-auto">
                    <template x-if="notifications.length === 0">
                      <div class="p-8 text-center">
                        <span
                          class="material-symbols-outlined text-4xl text-gray-300"
                          >notifications_off</span
                        >
                        <p class="text-sm text-gray-500 mt-2">
                          Kh√¥ng c√≥ th√¥ng b√°o m·ªõi
                        </p>
                      </div>
                    </template>
                    <div class="divide-y divide-gray-100">
                      <template x-for="notif in notifications" :key="notif.id">
                        <div class="p-4 hover:bg-gray-50 transition-colors">
                          <div class="flex items-start gap-3">
                            <div
                              class="bg-yellow-100 rounded-lg p-2 flex-shrink-0"
                            >
                              <span
                                class="material-symbols-outlined text-yellow-600 text-xl"
                                >assignment</span
                              >
                            </div>
                            <div class="flex-1 min-w-0">
                              <p
                                class="text-sm font-semibold text-gray-900 mb-1"
                                x-text="notif.taskName"
                              ></p>
                              <div class="space-y-1 mb-2">
                                <p
                                  class="text-xs text-gray-600 flex items-center gap-1"
                                >
                                  <span
                                    class="material-symbols-outlined text-[14px]"
                                    >location_on</span
                                  >
                                  <span x-text="notif.location"></span>
                                </p>
                                <p
                                  class="text-xs text-gray-600 flex items-center gap-1"
                                >
                                  <span
                                    class="material-symbols-outlined text-[14px]"
                                    >schedule</span
                                  >
                                  <span
                                    >Th·ªùi h·∫°n:
                                    <span x-text="notif.deadline"></span
                                  ></span>
                                </p>
                              </div>
                              <div class="flex gap-2">
                                <a
                                  :href="'activity-detail.html?id=' + notif.activityId"
                                  class="text-xs text-olive hover:underline font-medium"
                                  >Xem chi ti·∫øt</a
                                >
                                <button
                                  @click="confirmRead(notif.id)"
                                  class="text-xs text-blue-600 hover:underline font-medium"
                                >
                                  X√°c nh·∫≠n ƒë√£ ƒë·ªçc
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                  <div
                    x-show="notifications.length > 0"
                    class="px-4 py-3 border-t border-gray-200 bg-gray-50"
                  >
                    <button
                      @click="markAllRead()"
                      class="text-xs text-olive hover:underline font-medium w-full text-center"
                    >
                      ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
                    </button>
                  </div>
                </div>
              </div>
              <a
                href="activity-list.html"
                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center gap-2"
              >
                <span class="material-symbols-outlined">arrow_back</span>
                <span>Quay l·∫°i</span>
              </a>
            </div>
          </div>
        </header>

        <!-- Tabs -->
        <div class="bg-white border-b border-gray-200 px-6">
          <div class="flex gap-6">
            <button
              @click="activeTab = 'info'"
              :class="activeTab === 'info' ? 'border-olive text-olive' : 'border-transparent text-gray-500'"
              class="py-3 border-b-2 font-medium text-sm"
            >
              Th√¥ng tin
            </button>
            <button
              @click="activeTab = 'tasks'"
              :class="activeTab === 'tasks' ? 'border-olive text-olive' : 'border-transparent text-gray-500'"
              class="py-3 border-b-2 font-medium text-sm flex items-center gap-2"
            >
              <span>Nhi·ªám v·ª•</span>
              <span
                class="px-2 py-0.5 bg-olive text-white text-xs rounded-full"
                x-text="tasks.length"
              ></span>
            </button>
          </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-auto p-6">
          <!-- Info Tab -->
          <div x-show="activeTab === 'info'" class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg border border-gray-200 p-6">
              <h2 class="text-lg font-bold text-gray-900 mb-4">
                Th√¥ng tin chi ti·∫øt
              </h2>
              <div class="grid grid-cols-2 gap-6">
                <div>
                  <p class="text-sm text-gray-500 mb-1">Lo·∫°i c√¥ng vi·ªác</p>
                  <p
                    class="font-medium text-gray-900"
                    x-text="activity?.workType === 'kehoach' ? 'K·∫ø ho·∫°ch nƒÉm' : 'ƒê·ªôt xu·∫•t'"
                  ></p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 mb-1">Nh√≥m c√¥ng vi·ªác</p>
                  <p
                    class="font-medium text-gray-900"
                    x-text="activity?.workGroup"
                  ></p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 mb-1">T·ªï ph·ª• tr√°ch</p>
                  <p
                    class="font-medium text-gray-900"
                    x-text="`T·ªï ${activity?.department}`"
                  ></p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 mb-1">S·ªë c√¥ng vƒÉn</p>
                  <p
                    class="font-medium text-gray-900"
                    x-text="activity?.documentNumber || 'Ch∆∞a c√≥'"
                  ></p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 mb-1">Ng√†y b·∫Øt ƒë·∫ßu</p>
                  <p
                    class="font-medium text-gray-900"
                    x-text="activity?.startDate"
                  ></p>
                </div>
                <div>
                  <p class="text-sm text-gray-500 mb-1">Ng√†y k·∫øt th√∫c</p>
                  <p
                    class="font-medium text-gray-900"
                    x-text="activity?.endDate"
                  ></p>
                </div>
                <div class="col-span-2">
                  <p class="text-sm text-gray-500 mb-1">ƒê·ªãa ƒëi·ªÉm</p>
                  <p
                    class="font-medium text-gray-900"
                    x-text="activity?.location || 'Ch∆∞a x√°c ƒë·ªãnh'"
                  ></p>
                </div>
              </div>

              <!-- Progress -->
              <div class="mt-6 pt-6 border-t border-gray-200">
                <h3 class="text-sm font-bold text-gray-900 mb-3">
                  Ti·∫øn ƒë·ªô th·ª±c hi·ªán
                </h3>
                <div class="flex items-center justify-between text-sm mb-2">
                  <span class="text-gray-600">Ho√†n th√†nh</span>
                  <span
                    class="font-bold text-olive"
                    x-text="`${taskProgress}%`"
                  ></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                  <div
                    class="h-3 rounded-full transition-all"
                    :class="taskProgress === 100 ? 'bg-green-500' : 'bg-olive'"
                    :style="`width: ${taskProgress}%`"
                  ></div>
                </div>
                <p class="text-sm text-gray-600 mt-2">
                  <span x-text="completedTasks"></span> /
                  <span x-text="tasks.length"></span> nhi·ªám v·ª• ƒë√£ ho√†n th√†nh
                </p>
              </div>
            </div>
          </div>

          <!-- Tasks Tab -->
          <div x-show="activeTab === 'tasks'" class="max-w-6xl mx-auto">
            <div class="space-y-4">
              <template x-for="(task, index) in tasks" :key="task.id">
                <div class="bg-white rounded-lg border border-gray-200 p-5">
                  <div class="flex items-start gap-4">
                    <!-- Content -->
                    <div class="flex-1">
                      <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                          <h3
                            class="text-lg font-bold text-gray-900"
                            :class="getTaskStatus(task) === 'Ho√†n th√†nh' ? 'line-through text-gray-500' : ''"
                            x-text="task.title"
                          ></h3>
                          <div
                            class="flex items-center gap-4 mt-2 text-sm text-gray-600"
                          >
                            <div class="flex items-center gap-1">
                              <span class="material-symbols-outlined text-sm"
                                >group</span
                              >
                              <span x-text="task.team"></span>
                            </div>
                            <div class="flex items-center gap-1">
                              <span class="material-symbols-outlined text-sm"
                                >person</span
                              >
                              <span x-text="task.assignees.join(', ')"></span>
                            </div>
                            <div class="flex items-center gap-1">
                              <span class="material-symbols-outlined text-sm"
                                >calendar_today</span
                              >
                              <span x-text="task.dueDate"></span>
                            </div>
                          </div>
                        </div>
                        <!-- Task Status Button & Overdue -->
                        <div class="flex items-center gap-2 flex-wrap">
                          <!-- Overdue Badge -->
                          <span
                            x-show="task.isOverdue && getTaskStatus(task) !== 'Ho√†n th√†nh'"
                            class="px-2 py-1 bg-red-100 text-red-700 text-xs font-medium rounded-full"
                            >‚ö† Qu√° h·∫°n</span
                          >

                          <!-- Single Status Button -->
                          <button
                            @click.stop="cycleTaskStatus(task)"
                            :disabled="!canToggleTask(task) || getTaskStatus(task) === 'Ho√†n th√†nh'"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all"
                            :class="{
                              'bg-yellow-100 text-yellow-700 border border-yellow-200 hover:bg-yellow-200 cursor-pointer': getTaskStatus(task) === 'Ch·ªù nh·∫≠n nhi·ªám v·ª•' && canToggleTask(task),
                              'bg-blue-100 text-blue-700 border border-blue-200 hover:bg-blue-200 cursor-pointer': getTaskStatus(task) === 'Ch∆∞a b·∫Øt ƒë·∫ßu' && canToggleTask(task),
                              'bg-green-100 text-green-700 border border-green-200 cursor-default': getTaskStatus(task) === 'Ho√†n th√†nh',
                              'opacity-60 cursor-not-allowed': !canToggleTask(task) && getTaskStatus(task) !== 'Ho√†n th√†nh'
                            }"
                          >
                            <span
                              class="size-2 rounded-full"
                              :class="{
                                'bg-yellow-600': getTaskStatus(task) === 'Ch·ªù nh·∫≠n nhi·ªám v·ª•',
                                'bg-blue-600': getTaskStatus(task) === 'Ch∆∞a b·∫Øt ƒë·∫ßu',
                                'bg-green-600': getTaskStatus(task) === 'Ho√†n th√†nh'
                              }"
                            ></span>
                            <span x-text="getTaskStatus(task)"></span>
                            <span
                              x-show="getTaskStatus(task) !== 'Ho√†n th√†nh' && canToggleTask(task)"
                              class="material-symbols-outlined text-sm"
                              >arrow_forward</span
                            >
                          </button>
                        </div>
                      </div>

                      <!-- Notes -->
                      <div
                        x-show="task.notes"
                        class="mt-3 p-3 bg-gray-50 rounded-lg"
                      >
                        <p
                          class="text-sm text-gray-600"
                          x-text="task.notes"
                        ></p>
                      </div>

                      <!-- Report Fields -->
                      <div
                        x-show="task.reportFields && task.reportFields.length > 0"
                        class="mt-3 space-y-2"
                      >
                        <p class="text-sm font-medium text-gray-700">
                          B√°o c√°o:
                        </p>
                        <template
                          x-for="field in task.reportFields"
                          :key="field.name"
                        >
                          <div class="flex items-center gap-3">
                            <label
                              class="text-sm text-gray-600 w-48"
                              x-text="field.name"
                            ></label>
                            <input
                              type="text"
                              x-model="field.value"
                              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-olive focus:border-olive"
                              :placeholder="`Nh·∫≠p ${field.name.toLowerCase()}`"
                            />
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      function activityDetail() {
        return {
          activeTab: "tasks",
          activity: null,
          tasks: [],
          currentUser: null,

          init() {
            // Check authentication
            const session = localStorage.getItem("dqp10_session");
            if (!session) {
              window.location.href = "login.html";
              return;
            }
            this.currentUser = JSON.parse(session);

            // Get activity ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const activityId = parseInt(urlParams.get("id"));

            if (!activityId) {
              alert("Kh√¥ng t√¨m th·∫•y ID ho·∫°t ƒë·ªông");
              window.location.href = "activity-list.html";
              return;
            }

            const data = localStorage.getItem("dqp10_activities");
            if (!data) {
              alert("Kh√¥ng c√≥ d·ªØ li·ªáu ho·∫°t ƒë·ªông");
              window.location.href = "activity-list.html";
              return;
            }

            const activities = JSON.parse(data);
            this.activity = activities.find((a) => a.id === activityId);

            if (!this.activity) {
              alert("Kh√¥ng t√¨m th·∫•y ho·∫°t ƒë·ªông");
              window.location.href = "activity-list.html";
              return;
            }

            // Map tasks from activity data
            this.tasks = this.activity.tasks.map((task, index) => ({
              id: index + 1,
              title: task.title,
              assignees: task.assignees
                ? task.assignees.split(",").map((a) => a.trim())
                : [],
              dueDate: task.dueDate,
              isOverdue: this.checkOverdue(task.dueDate),
              completed: task.completed || false,
              reportFields: task.reportFields || [],
              team: task.team,
              notes: task.notes || "",
            }));

            // Sort tasks: user's team tasks first
            this.sortTasksByTeam();
          },

          sortTasksByTeam() {
            if (this.currentUser.role === "admin") return; // Admin sees all in original order

            const userTeam = this.currentUser.team; // e.g., "T·ªï 3"
            this.tasks.sort((a, b) => {
              const aIsUserTeam = a.team === userTeam;
              const bIsUserTeam = b.team === userTeam;

              if (aIsUserTeam && !bIsUserTeam) return -1; // a first
              if (!aIsUserTeam && bIsUserTeam) return 1; // b first
              return 0; // keep original order
            });
          },

          canToggleTask(task) {
            // Admin can toggle all tasks
            if (this.currentUser.role === "admin") return true;

            // User can only toggle tasks where they are assigned
            // Check if user's fullName is in the assignees list
            const userFullName = this.currentUser.fullName;
            if (task.assignees && task.assignees.includes(userFullName)) {
              return true;
            }

            // Also check if user is in same team (fallback for team-level access)
            // This allows any team member to help with team tasks
            // Comment out next line if you want STRICT assignee-only access
            // return task.team === this.currentUser.team;

            return false;
          },

          checkOverdue(dueDate) {
            const parseDate = (dateStr) => {
              const [day, month, year] = dateStr.split("/");
              return new Date(year, month - 1, day);
            };
            const due = parseDate(dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return due < today;
          },

          get completedTasks() {
            return this.tasks.filter((t) => t.completed).length;
          },

          get taskProgress() {
            return this.tasks.length > 0
              ? Math.round((this.completedTasks / this.tasks.length) * 100)
              : 0;
          },

          getTaskStatus(task) {
            // Return task status with default "Ch·ªù nh·∫≠n nhi·ªám v·ª•"
            return task.status || "Ch·ªù nh·∫≠n nhi·ªám v·ª•";
          },

          cycleTaskStatus(task) {
            // Check permission
            if (!this.canToggleTask(task)) {
              alert(
                `‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn c·∫≠p nh·∫≠t nhi·ªám v·ª• n√†y!\n\nNhi·ªám v·ª• "${task.title}" thu·ªôc ${task.team}.`,
              );
              return;
            }

            const currentStatus = this.getTaskStatus(task);

            // Define status workflow
            const nextStatus = {
              "Ch·ªù nh·∫≠n nhi·ªám v·ª•": "Ch∆∞a b·∫Øt ƒë·∫ßu",
              "Ch∆∞a b·∫Øt ƒë·∫ßu": "Ho√†n th√†nh",
              "Ho√†n th√†nh": "Ho√†n th√†nh", // No change if already complete
            };

            const newStatus = nextStatus[currentStatus];
            if (newStatus === currentStatus) return; // Already complete

            this.changeTaskStatus(task, newStatus);
          },

          changeTaskStatus(task, newStatus) {
            // Check permission
            if (!this.canToggleTask(task)) {
              alert(
                `‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn c·∫≠p nh·∫≠t nhi·ªám v·ª• n√†y!\n\nNhi·ªám v·ª• "${task.title}" thu·ªôc ${task.team}.`,
              );
              return;
            }

            // Update task status
            task.status = newStatus;

            // If marking as complete, also set completed flag
            if (newStatus === "Ho√†n th√†nh") {
              task.completed = true;
            }

            // Save to localStorage
            const data = localStorage.getItem("dqp10_activities");
            if (data) {
              const activities = JSON.parse(data);
              const activity = activities.find(
                (a) => a.id === this.activity.id,
              );
              if (activity) {
                const taskIndex = this.tasks.indexOf(task);
                if (taskIndex !== -1 && activity.tasks[taskIndex]) {
                  activity.tasks[taskIndex].status = newStatus;
                  if (newStatus === "Ho√†n th√†nh") {
                    activity.tasks[taskIndex].completed = true;
                  }
                  localStorage.setItem(
                    "dqp10_activities",
                    JSON.stringify(activities),
                  );
                }
              }
            }

            // Show confirmation
            const messages = {
              "Ch∆∞a b·∫Øt ƒë·∫ßu": "‚úÖ ƒê√£ x√°c nh·∫≠n nh·∫≠n nhi·ªám v·ª•!",
              "Ho√†n th√†nh": "üéâ Nhi·ªám v·ª• ƒë√£ ho√†n th√†nh!",
            };
            alert(
              messages[newStatus] || `‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i: ${newStatus}`,
            );
          },

          handleTaskClick(event, task) {
            // Check permission FIRST
            if (!this.canToggleTask(task)) {
              event.preventDefault(); // Block checkbox toggle
              alert(
                `‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn c·∫≠p nh·∫≠t nhi·ªám v·ª• n√†y!\n\n` +
                  `Nhi·ªám v·ª• "${task.title}" thu·ªôc ${task.team}.\n` +
                  `B·∫°n ch·ªâ c√≥ th·ªÉ c·∫≠p nh·∫≠t nhi·ªám v·ª• c·ªßa ${this.currentUser.team}.`,
              );
              return;
            }

            // Permission OK - toggle task
            this.toggleTask(task);
          },

          toggleTask(task) {
            task.completed = !task.completed;

            // Update localStorage
            const data = localStorage.getItem("dqp10_activities");
            if (data) {
              const activities = JSON.parse(data);
              const activity = activities.find(
                (a) => a.id === this.activity.id,
              );
              if (activity) {
                const taskIndex = this.tasks.indexOf(task);
                if (taskIndex !== -1 && activity.tasks[taskIndex]) {
                  activity.tasks[taskIndex].completed = task.completed;
                  localStorage.setItem(
                    "dqp10_activities",
                    JSON.stringify(activities),
                  );
                }
              }
            }

            if (this.taskProgress === 100) {
              setTimeout(() => {
                alert("üéâ T·∫•t c·∫£ nhi·ªám v·ª• ƒë√£ ho√†n th√†nh!");
              }, 300);
            }
          },
        };
      }
    </script>

    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>
  </body>
</html>
