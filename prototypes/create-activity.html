<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T·∫°o Ho·∫°t ƒë·ªông/C√¥ng vi·ªác - D√¢n Qu√¢n T·ª± V·ªá</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="notification-system.js"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <style>
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              olive: {
                DEFAULT: "#697565",
                50: "#f6f7f6",
                100: "#e3e6e2",
                200: "#c7cdc5",
                300: "#a5ada0",
                400: "#858e7f",
                500: "#697565",
                600: "#535d50",
                700: "#434a42",
                800: "#373c36",
                900: "#2f332e",
              },
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-50" x-data="createActivity()">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside
        class="w-64 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col p-4 hidden md:flex h-full"
      >
        <div class="flex gap-3 px-2 py-2 mb-4">
          <img src="logo-dqtv.png" alt="Logo" class="size-10 object-contain" />
          <div class="flex flex-col justify-center">
            <h1 class="text-gray-900 text-base font-bold">Ph∆∞·ªùng ƒë·ªôi B√¨nh Ph√∫</h1>
            <p class="text-gray-500 text-xs">H·ªá th·ªëng qu·∫£n l√Ω</p>
          </div>
        </div>

        <!-- User Profile Card -->
        <div
          class="bg-gradient-to-r from-olive/10 to-olive/5 rounded-xl p-3 mb-4 border border-olive/20"
        >
          <div class="flex items-center gap-3">
            <div class="relative">
              <div
                class="bg-olive/20 rounded-full size-10 flex items-center justify-center"
              >
                <span class="material-symbols-outlined text-olive text-lg"
                  >person</span
                >
              </div>
              <span
                class="absolute bottom-0 right-0 size-2.5 bg-green-500 rounded-full border-2 border-white"
              ></span>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-bold text-gray-900 truncate">
                Nguy·ªÖn VƒÉn Quang
              </p>
              <p class="text-xs text-gray-600">DQTT</p>
            </div>
          </div>
        </div>

        <nav class="flex flex-col gap-2">
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="index.html"
          >
            <span class="material-symbols-outlined text-gray-600">home</span>
            <p class="text-sm font-medium text-gray-600">Trang ch·ªß</p>
          </a>
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="dashboard-tong-hop.html"
          >
            <span class="material-symbols-outlined text-gray-600"
              >assessment</span
            >
            <p class="text-sm font-medium text-gray-600">Dashboard</p>
          </a>

          <!-- Ho·∫°t ƒë·ªông Submenu -->
          <div>
            <div class="flex items-center gap-3 px-3 py-2 text-gray-700">
              <span class="material-symbols-outlined text-gray-600">event</span>
              <p class="text-sm font-bold text-gray-700">Ho·∫°t ƒë·ªông</p>
            </div>
            <div class="ml-6 space-y-1 border-l-2 border-gray-200 pl-3">
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="activity-list.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">Danh s√°ch</p>
              </a>
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="activity-calendar.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">L·ªãch</p>
              </a>
              <a
                class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600"
                href="module-lich-truc.html"
              >
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">L·ªãch tr·ª±c</p>
              </a>
            </div>
          </div>

          <!-- Nh√¢n s·ª± with submenu -->
          <div>
            <div class="flex items-center gap-3 px-3 py-2 text-gray-700">
              <span class="material-symbols-outlined text-gray-600">group</span>
              <p class="text-sm font-bold text-gray-700">Nh√¢n s·ª±</p>
            </div>
            <div class="ml-6 space-y-1 border-l-2 border-gray-200 pl-3">
              <a class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600" href="personnel-tuoi17.html">
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">Tu·ªïi 17</p>
              </a>
              <a class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600" href="personnel-nguon.html">
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">Ngu·ªìn</p>
              </a>
              <a class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600" href="personnel-qndb.html">
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">Qu√¢n nh√¢n d·ª± b·ªã</p>
              </a>
              <a class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600" href="personnel-dqtt.html">
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">DQTT</p>
              </a>
              <a class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-50 text-gray-600" href="personnel-dqcd.html">
                <span class="size-1.5 rounded-full bg-gray-400"></span>
                <p class="text-sm font-medium">DQCƒê</p>
              </a>
            </div>
          </div>

          <!-- Kho -->
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="module3-inventory-complete.html"
          >
            <span class="material-symbols-outlined text-gray-600"
              >inventory_2</span
            >
            <p class="text-sm font-medium text-gray-600">Kho</p>
          </a>

          <!-- T√†i li·ªáu -->
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors"
            href="module4-documents-complete.html"
          >
            <span class="material-symbols-outlined text-gray-600">folder</span>
            <p class="text-sm font-medium text-gray-600">T√†i li·ªáu</p>
          </a>
        </nav>

        <div class="mt-auto pt-4 border-t border-gray-200 space-y-2">
          <a
            class="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-bold bg-olive text-white hover:bg-olive/90 transition-colors justify-center"
            href="#"
          >
            <span class="material-symbols-outlined text-xl">logout</span>
            <span>ƒêƒÉng xu·∫•t</span>
          </a>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold text-gray-900">T·∫°o k·∫ø ho·∫°ch m·ªõi</h1>
              <p class="text-sm text-gray-500 mt-1">
                ƒêi·ªÅn th√¥ng tin chi ti·∫øt cho k·∫ø ho·∫°ch m·ªõi
              </p>
            </div>
            <div class="flex items-center gap-3">
              <!-- Notification Bell System -->
              <div x-data="notificationBell" class="relative">
                <button @click="toggleDropdown()" class="relative p-2 hover:bg-gray-100 rounded-lg transition-colors" :class="{'bg-gray-100': isOpen}">
                  <span class="material-symbols-outlined">notifications</span>
                  <span x-show="unreadCount > 0" class="absolute top-2 right-2 size-2 bg-red-500 rounded-full"></span>
                  <span x-show="unreadCount > 0" x-text="unreadCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full px-1.5 py-0.5 min-w-[20px] text-center"></span>
                </button>
                <div x-show="isOpen" @click.away="isOpen = false" class="absolute right-0 mt-2 w-96 bg-white rounded-xl shadow-2xl border border-gray-200 z-50" style="display: none" x-cloak>
                  <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-sm font-bold text-gray-900">Th√¥ng b√°o nhi·ªám v·ª•</h3>
                    <span class="text-xs text-gray-500" x-text="notifications.length + ' nhi·ªám v·ª•'"></span>
                  </div>
                  <div class="max-h-96 overflow-y-auto">
                    <template x-if="notifications.length === 0">
                      <div class="p-8 text-center">
                        <span class="material-symbols-outlined text-4xl text-gray-300">notifications_off</span>
                        <p class="text-sm text-gray-500 mt-2">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</p>
                      </div>
                    </template>
                    <div class="divide-y divide-gray-100">
                      <template x-for="notif in notifications" :key="notif.id">
                        <div class="p-4 hover:bg-gray-50 transition-colors">
                          <div class="flex items-start gap-3">
                            <div class="bg-yellow-100 rounded-lg p-2 flex-shrink-0">
                              <span class="material-symbols-outlined text-yellow-600 text-xl">assignment</span>
                            </div>
                            <div class="flex-1 min-w-0">
                              <p class="text-sm font-semibold text-gray-900 mb-1" x-text="notif.taskName"></p>
                              <div class="space-y-1 mb-2">
                                <p class="text-xs text-gray-600 flex items-center gap-1">
                                  <span class="material-symbols-outlined text-[14px]">location_on</span>
                                  <span x-text="notif.location"></span>
                                </p>
                                <p class="text-xs text-gray-600 flex items-center gap-1">
                                  <span class="material-symbols-outlined text-[14px]">schedule</span>
                                  <span>Th·ªùi h·∫°n: <span x-text="notif.deadline"></span></span>
                                </p>
                              </div>
                              <div class="flex gap-2">
                                <a :href="'activity-detail.html?id=' + notif.activityId" class="text-xs text-olive hover:underline font-medium">Xem chi ti·∫øt</a>
                                <button @click="confirmRead(notif.id)" class="text-xs text-blue-600 hover:underline font-medium">X√°c nh·∫≠n ƒë√£ ƒë·ªçc</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                  <div x-show="notifications.length > 0" class="px-4 py-3 border-t border-gray-200 bg-gray-50">
                    <button @click="markAllRead()" class="text-xs text-olive hover:underline font-medium w-full text-center">ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc</button>
                  </div>
                </div>
              </div>
              <a
                href="module1-activities-complete.html"
                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2"
              >
                <span class="material-symbols-outlined">arrow_back</span>
                <span>Quay l·∫°i</span>
            </a>
          </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-auto p-6">
          <div class="max-w-4xl mx-auto">
            <form
              @submit.prevent="submitActivity"
              class="bg-white rounded-lg border border-gray-200 p-6"
            >
              <!-- Section 1: Th√¥ng tin c∆° b·∫£n -->
              <div class="mb-6">
                <h2
                  class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2"
                >
                  <span class="material-symbols-outlined text-olive">info</span>
                  Th√¥ng tin c∆° b·∫£n
                </h2>

                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      T√™n k·∫ø ho·∫°ch <span class="text-red-500">*</span>
                    </label>
                    <input
                      x-model="formData.name"
                      type="text"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive"
                      placeholder="VD: Hu·∫•n luy·ªán s·ª≠ d·ª•ng v≈© kh√≠"
                    />
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        Lo·∫°i ho·∫°t ƒë·ªông <span class="text-red-500">*</span>
                      </label>
                      <select
                        x-model="formData.workType"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive"
                      >
                        <option value="">-- Ch·ªçn lo·∫°i c√¥ng vi·ªác --</option>
                        <option value="phat-sinh">
                          üî¥ C√¥ng vi·ªác ph√°t sinh (ƒë·ªôt xu·∫•t)
                        </option>
                        <option value="ke-hoach">
                          üü¢ C√¥ng vi·ªác theo k·∫ø ho·∫°ch nƒÉm
                        </option>
                      </select>
                      <p class="mt-1 text-xs text-gray-500">
                        T·∫•t c·∫£ c√¥ng vi·ªác ƒë·ªÅu t√≠nh v√†o KPI nƒÉm
                      </p>
                    </div>

                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        Nh√≥m c√¥ng vi·ªác <span class="text-red-500">*</span>
                      </label>
                      <select
                        x-model="formData.workGroup"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive"
                      >
                        <option value="">-- Ch·ªçn nh√≥m c√¥ng vi·ªác --</option>
                        <template x-for="group in workGroups" :key="group.code">
                          <option
                            :value="group.code"
                            x-text="group.name"
                          ></option>
                        </template>
                      </select>
                      <p
                        class="mt-1 text-xs text-gray-500"
                        x-show="formData.workGroup"
                      >
                        Ti·∫øn ƒë·ªô nh√≥m:
                        <span
                          class="font-semibold"
                          x-text="getGroupProgress(formData.workGroup)"
                        ></span>
                      </p>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        T·ªï ph·ª• tr√°ch <span class="text-red-500">*</span>
                      </label>
                      <select
                        x-model="formData.to"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive"
                      >
                        <option value="">-- Ch·ªçn t·ªï --</option>
                        <option value="1">T·ªï 1</option>
                        <option value="2">T·ªï 2</option>
                        <option value="3">T·ªï 3</option>
                        <option value="4">T·ªï 4</option>
                        <option value="5">T·ªï 5</option>
                        <option value="6">T·ªï 6</option>
                        <option value="7">T·ªï 7</option>
                        <option value="8">T·ªï 8</option>
                        <option value="9">T·ªï 9</option>
                      </select>
                    </div>

                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        ƒê·ªãa ƒëi·ªÉm
                      </label>
                      <input
                        x-model="formData.location"
                        type="text"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive"
                        placeholder="VD: S√¢n t·∫≠p P10, Kho v≈© kh√≠..."
                      />
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        Ng√†y b·∫Øt ƒë·∫ßu <span class="text-red-500">*</span>
                      </label>
                      <input
                        x-model="formData.startDateInput"
                        @change="formData.startDate = formatDateDisplay($event.target.value)"
                        type="date"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive"
                      />
                    </div>

                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        Ng√†y k·∫øt th√∫c <span class="text-red-500">*</span>
                      </label>
                      <input
                        x-model="formData.endDateInput"
                        @change="formData.endDate = formatDateDisplay($event.target.value)"
                        type="date"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive"
                      />
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        S·ªë c√¥ng vƒÉn
                      </label>
                      <input
                        x-model="formData.documentNumber"
                        type="text"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive"
                        placeholder="VD: 123/CV-DQ..."
                      />
                      <p class="mt-1 text-xs text-gray-500">
                        üí° S·ªë hi·ªáu c√¥ng vƒÉn li√™n quan (n·∫øu c√≥)
                      </p>
                    </div>

                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        ƒê√≠nh k√®m t√†i li·ªáu
                      </label>
                      <input
                        type="file"
                        @change="handleFileUpload"
                        multiple
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-olive/10 file:text-olive hover:file:bg-olive/20"
                      />
                      <p class="mt-1 text-xs text-gray-500">
                        üìé H·ªó tr·ª£: PDF, DOC, DOCX, JPG, PNG (T·ªëi ƒëa 10MB)
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Section 2: Nhi·ªám v·ª• -->
              <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                  <h2
                    class="text-lg font-semibold text-gray-900 flex items-center gap-2"
                  >
                    <span class="material-symbols-outlined text-olive"
                      >task</span
                    >
                    Nhi·ªám v·ª•
                  </h2>
                  <button
                    type="button"
                    @click="addTask"
                    class="px-3 py-1 text-sm bg-olive text-white rounded-lg hover:bg-olive/90 transition-colors flex items-center gap-1"
                  >
                    <span class="material-symbols-outlined text-lg">add</span>
                    <span>Th√™m nhi·ªám v·ª•</span>
                  </button>
                </div>

                <div class="space-y-3">
                  <template
                    x-for="(task, index) in formData.tasks"
                    :key="index"
                  >
                    <div
                      class="border border-gray-200 rounded-lg p-4 bg-gray-50"
                    >
                      <div class="flex items-start justify-between mb-3">
                        <h3 class="font-medium text-gray-900">
                          Nhi·ªám v·ª• <span x-text="index + 1"></span>
                        </h3>
                        <button
                          type="button"
                          @click="removeTask(index)"
                          class="text-red-600 hover:bg-red-50 p-1 rounded"
                        >
                          <span class="material-symbols-outlined text-lg"
                            >delete</span
                          >
                        </button>
                      </div>

                      <div class="space-y-3">
                        <div>
                          <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >T√™n nhi·ªám v·ª•
                            <span class="text-red-500">*</span></label
                          >
                          <input
                            x-model="task.title"
                            type="text"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-olive"
                            placeholder="VD: Chu·∫©n b·ªã v≈© kh√≠"
                          />
                        </div>

                        <div>
                          <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                          >
                            T·ªï ph·ª• tr√°ch
                          </label>
                          <select
                            x-model="task.team"
                            @change="task.assignees = ''"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-olive"
                          >
                            <option value="">T·∫•t c·∫£</option>
                            <option value="T·ªï 1">T·ªï 1</option>
                            <option value="T·ªï 2">T·ªï 2</option>
                            <option value="T·ªï 3">T·ªï 3</option>
                            <option value="T·ªï 4">T·ªï 4</option>
                            <option value="T·ªï 5">T·ªï 5</option>
                            <option value="T·ªï 6">T·ªï 6</option>
                            <option value="T·ªï 7">T·ªï 7</option>
                            <option value="T·ªï 8">T·ªï 8</option>
                            <option value="T·ªï 9">T·ªï 9</option>
                          </select>
                          <p class="mt-1 text-xs text-gray-500">
                            üí° Ch·ªçn t·ªï ƒë·ªÉ l·ªçc ng∆∞·ªùi th·ª±c hi·ªán
                          </p>
                        </div>

                        <div>
                          <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Ng∆∞·ªùi th·ª±c hi·ªán (1-2 ng∆∞·ªùi)
                            <span class="text-red-500">*</span></label
                          >
                          <select
                            x-model="task.assignees"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-olive"
                          >
                            <option value="">-- Ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán --</option>
                            <template
                              x-for="user in getUsersByTeam(task.team)"
                              :key="user.name"
                            >
                              <option
                                :value="user.name"
                                x-text="user.name"
                              ></option>
                            </template>
                          </select>
                          <p class="mt-1 text-xs text-gray-500">
                            <span
                              x-show="!task.team || task.team === ''"
                              class="text-blue-600"
                            >
                              üí° Hi·ªÉn th·ªã t·∫•t c·∫£ users. Ch·ªçn T·ªï ƒë·ªÉ l·ªçc.
                            </span>
                            <span
                              x-show="task.team && task.team !== ''"
                              class="text-olive"
                            >
                              ‚úì ƒêang l·ªçc theo <span x-text="task.team"></span>
                            </span>
                          </p>
                        </div>

                        <div>
                          <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Th·ªùi h·∫°n ho√†n th√†nh</label
                          >
                          <input
                            x-model="task.dueDateInput"
                            @change="task.dueDate = formatDateDisplay($event.target.value)"
                            type="date"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-olive"
                          />
                          <p class="mt-1 text-xs text-orange-600">
                            ‚ö†Ô∏è Khi qu√° h·∫°n, h·ªá th·ªëng s·∫Ω g·ª≠i email c·∫£nh b√°o t·ª±
                            ƒë·ªông
                          </p>
                        </div>

                        <!-- H·∫°ng m·ª•c b√°o c√°o -->
                        <div class="border-t border-gray-200 pt-3 mt-3">
                          <div class="flex items-center justify-between mb-2">
                            <label
                              class="block text-sm font-medium text-gray-700"
                              >H·∫°ng m·ª•c b√°o c√°o (t√πy ch·ªçn)</label
                            >
                            <button
                              type="button"
                              @click="addReportField(task)"
                              class="text-xs text-olive hover:text-olive/80 flex items-center gap-1"
                            >
                              <span class="material-symbols-outlined text-sm"
                                >add</span
                              >
                              <span>Th√™m h·∫°ng m·ª•c</span>
                            </button>
                          </div>

                          <template
                            x-if="!task.reportFields || task.reportFields.length === 0"
                          >
                            <p class="text-xs text-gray-500 italic">
                              Ch∆∞a c√≥ h·∫°ng m·ª•c b√°o c√°o n√†o
                            </p>
                          </template>

                          <div
                            class="space-y-2"
                            x-show="task.reportFields && task.reportFields.length > 0"
                          >
                            <template
                              x-for="(field, fieldIndex) in task.reportFields"
                              :key="fieldIndex"
                            >
                              <div class="flex items-center gap-2">
                                <input
                                  x-model="field.name"
                                  type="text"
                                  class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-olive"
                                  placeholder="VD: S·ªë l∆∞·ª£ng s√∫ng, S·ªë ng∆∞·ªùi tham gia..."
                                />
                                <button
                                  type="button"
                                  @click="task.reportFields.splice(fieldIndex, 1)"
                                  class="text-red-600 hover:bg-red-50 p-1 rounded"
                                >
                                  <span
                                    class="material-symbols-outlined text-lg"
                                    >close</span
                                  >
                                </button>
                              </div>
                            </template>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>

                  <div
                    x-show="formData.tasks.length === 0"
                    class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center"
                  >
                    <span
                      class="material-symbols-outlined text-4xl text-gray-400"
                      >task_alt</span
                    >
                    <p class="mt-2 text-sm text-gray-500">
                      Ch∆∞a c√≥ nhi·ªám v·ª• n√†o. Nh·∫•n "Th√™m nhi·ªám v·ª•" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Actions -->
              <div
                class="flex items-center justify-end gap-3 pt-4 border-t border-gray-200"
              >
                <button
                  type="button"
                  class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  H·ªßy
                </button>
                <button
                  type="submit"
                  class="px-6 py-2 bg-olive text-white rounded-lg hover:bg-olive/90 transition-colors flex items-center gap-2"
                >
                  <span class="material-symbols-outlined">save</span>
                  <span>T·∫°o ho·∫°t ƒë·ªông</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>

    <script>
      function createActivity() {
        return {
          formData: {
            name: "",
            workType: "",
            workGroup: "",
            to: "",
            startDate: "",
            endDate: "",
            startDateInput: "", // for date picker
            endDateInput: "", // for date picker
            documentNumber: "",
            location: "",
            // notes: "", // REMOVED - moved to task level
            attachedFiles: [],
            tasks: [],
          },
          workGroups: [
            {
              code: "HUANLUYEN",
              name: "C√¥ng t√°c Hu·∫•n luy·ªán",
              target: 20,
              completed: 15,
            },
            {
              code: "DIEUDONGG",
              name: "C√¥ng t√°c ƒêi·ªÅu ƒë·ªông",
              target: 30,
              completed: 12,
            },
            {
              code: "CHINHTR",
              name: "C√¥ng t√°c Ch√≠nh tr·ªã",
              target: 30,
              completed: 28,
            },
            {
              code: "KTTC",
              name: "Ki·ªÉm tra t√≠nh chi·∫øn ƒë·∫•u",
              target: 15,
              completed: 10,
            },
            {
              code: "VANNGH·ªÄ",
              name: "VƒÉn ngh·ªá - Th·ªÉ thao",
              target: 12,
              completed: 8,
            },
          ],
          allUsers: [],
          availableTasks: [],

          init() {
            // Load users from localStorage or create default
            const storedUsers = localStorage.getItem("dqp10_users");
            if (storedUsers) {
              this.allUsers = JSON.parse(storedUsers);
            } else {
              // 30 users ph√¢n b·ªï 9 t·ªï
              this.allUsers = [
                { name: "Nguy·ªÖn Thanh Nh√¢n", team: "T·ªï 1" },
                { name: "Nguy·ªÖn Minh Nh√¢n", team: "T·ªï 1" },
                { name: "Cao VƒÉn An", team: "T·ªï 1" },
                { name: "ƒê·∫∑ng VƒÉn Qu√Ω", team: "T·ªï 1" },
                { name: "Th√°i Thanh Phong", team: "T·ªï 2" },
                { name: "Phan Phong Ph√∫", team: "T·ªï 2" },
                { name: "D∆∞∆°ng VƒÉn B√¨nh", team: "T·ªï 2" },
                { name: "Hu·ª≥nh VƒÉn Sang", team: "T·ªï 2" },
                { name: "Nguy·ªÖn VƒÉn Quang", team: "T·ªï 3" },
                { name: "Nguy·ªÖn ƒê√¨nh Thi·ªán", team: "T·ªï 3" },
                { name: "L∆∞∆°ng VƒÉn Ch√≠nh", team: "T·ªï 3" },
                { name: "T√¥ VƒÉn Th·∫Øng", team: "T·ªï 3" },
                { name: "L√™ VƒÉn C∆∞·ªùng", team: "T·ªï 4" },
                { name: "Tr·∫ßn Minh ƒê·ª©c", team: "T·ªï 4" },
                { name: "Mai VƒÉn D≈©ng", team: "T·ªï 4" },
                { name: "Ph·∫°m VƒÉn H√πng", team: "T·ªï 5" },
                { name: "Ho√†ng VƒÉn Kh√°nh", team: "T·ªï 5" },
                { name: "H·ªì VƒÉn Ho√†ng", team: "T·ªï 5" },
                { name: "ƒê·ªó VƒÉn Long", team: "T·ªï 6" },
                { name: "B√πi VƒÉn Nam", team: "T·ªï 6" },
                { name: "Phan VƒÉn Ki√™n", team: "T·ªï 6" },
                { name: "V≈© VƒÉn Ph√∫c", team: "T·ªï 7" },
                { name: "Ng√¥ VƒÉn S∆°n", team: "T·ªï 7" },
                { name: "Nguy·ªÖn VƒÉn L√¢m", team: "T·ªï 7" },
                { name: "ƒêinh VƒÉn T√¢m", team: "T·ªï 8" },
                { name: "L√Ω VƒÉn To√†n", team: "T·ªï 8" },
                { name: "Tr·∫ßn VƒÉn Minh", team: "T·ªï 8" },
                { name: "V√µ VƒÉn Tu·∫•n", team: "T·ªï 9" },
                { name: "Tr∆∞∆°ng VƒÉn Vinh", team: "T·ªï 9" },
                { name: "L√™ VƒÉn Phong", team: "T·ªï 9" },
              ];
              localStorage.setItem(
                "dqp10_users",
                JSON.stringify(this.allUsers),
              );
            }

            // Load available tasks from localStorage or create default
            const stored = localStorage.getItem("availableTasks");
            if (stored) {
              this.availableTasks = JSON.parse(stored);
            } else {
              // Default 5 tasks
              this.availableTasks = [
                {
                  id: 1,
                  name: "H·ªçp tri·ªÉn khai k·∫ø ho·∫°ch qu√Ω 1",
                  to: "T·ªï 1",
                  status: "Ho√†n th√†nh",
                },
                {
                  id: 2,
                  name: "Ki·ªÉm tra trang b·ªã v≈© kh√≠",
                  to: "T·ªï 2",
                  status: "ƒêang th·ª±c hi·ªán",
                },
                {
                  id: 3,
                  name: "ƒê√°nh gi√° nƒÉng l·ª±c chi·∫øn ƒë·∫•u",
                  to: "T·ªï 3",
                  status: "ƒêang th·ª±c hi·ªán",
                },
                {
                  id: 4,
                  name: "T·ªï ch·ª©c vƒÉn ngh·ªá ch√†o m·ª´ng T·∫øt",
                  to: "T·ªï 4",
                  status: "Ch∆∞a b·∫Øt ƒë·∫ßu",
                },
                {
                  id: 5,
                  name: "Di·ªÖn t·∫≠p ph√≤ng ch·ªëng ch√°y n·ªï",
                  to: "T·ªï 5",
                  status: "ƒêang th·ª±c hi·ªán",
                },
              ];
              localStorage.setItem(
                "availableTasks",
                JSON.stringify(this.availableTasks),
              );
            }
          },

          addTask() {
            this.formData.tasks.push({
              title: "",
              team: "",
              assignees: "",
              dueDate: "",
              dueDateInput: "", // for date picker
              reportFields: [],
              notes: "", // NEW - Ghi ch√∫ for this task
            });
          },

          removeTask(index) {
            this.formData.tasks.splice(index, 1);
          },

          addReportField(task) {
            if (!task.reportFields) {
              task.reportFields = [];
            }
            task.reportFields.push({ name: "" });
          },

          // Convert date from yyyy-mm-dd (date picker) to dd/mm/yyyy (display)
          formatDateDisplay(dateString) {
            if (!dateString) return "";
            const [year, month, day] = dateString.split("-");
            return `${day}/${month}/${year}`;
          },

          getUsersByTeam(team) {
            if (!team || team === "") {
              return this.allUsers; // All users
            }
            return this.allUsers.filter((u) => u.team === team);
          },

          getGroupProgress(code) {
            const group = this.workGroups.find((g) => g.code === code);
            if (!group) return "";
            const progress = Math.round((group.completed / group.target) * 100);
            return `${group.completed}/${group.target} (${progress}%)`;
          },

          searchAssignees(event, task) {
            // Simulate autocomplete
            console.log("Searching assignees:", event.target.value);
          },

          handleFileUpload(event) {
            const files = Array.from(event.target.files);
            this.formData.attachedFiles = files;
            console.log(
              "Uploaded files:",
              files.map((f) => f.name),
            );
          },

          submitActivity() {
            console.log("Submitting activity:", this.formData);

            // Validation
            if (!this.formData.name) {
              alert("Vui l√≤ng nh·∫≠p t√™n ho·∫°t ƒë·ªông");
              return;
            }

            if (!this.formData.to) {
              alert("Vui l√≤ng ch·ªçn T·ªï ph·ª• tr√°ch");
              return;
            }

            if (this.formData.tasks.length === 0) {
              alert("Vui l√≤ng th√™m √≠t nh·∫•t 1 nhi·ªám v·ª•");
              return;
            }

            if (!this.formData.workGroup) {
              alert("Vui l√≤ng ch·ªçn Nh√≥m c√¥ng vi·ªác");
              return;
            }

            if (this.formData.endDate < this.formData.startDate) {
              alert("Ng√†y k·∫øt th√∫c ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu");
              return;
            }

            // Validate task dueDates are within activity date range
            const parseDate = (dateStr) => {
              const [day, month, year] = dateStr.split("/");
              return new Date(year, month - 1, day);
            };

            const activityStart = parseDate(this.formData.startDate);
            const activityEnd = parseDate(this.formData.endDate);

            for (let i = 0; i < this.formData.tasks.length; i++) {
              const task = this.formData.tasks[i];
              if (!task.dueDate) {
                alert(`Nhi·ªám v·ª• "${task.title}" ch∆∞a c√≥ th·ªùi h·∫°n ho√†n th√†nh`);
                return;
              }

              const taskDue = parseDate(task.dueDate);

              if (taskDue < activityStart || taskDue > activityEnd) {
                alert(
                  `‚ùå Th·ªùi h·∫°n ho√†n th√†nh kh√¥ng h·ª£p l·ªá!\n\n` +
                    `Nhi·ªám v·ª•: "${task.title}"\n` +
                    `Th·ªùi h·∫°n: ${task.dueDate}\n\n` +
                    `Th·ªùi h·∫°n ph·∫£i n·∫±m trong kho·∫£ng:\n` +
                    `T·ª´ ${this.formData.startDate} ƒë·∫øn ${this.formData.endDate}`,
                );
                return;
              }
            }

            // Load existing activities
            const data = localStorage.getItem("dqp10_activities");
            const activities = data ? JSON.parse(data) : [];

            // Generate new ID
            const newId =
              activities.length > 0
                ? Math.max(...activities.map((a) => a.id)) + 1
                : 1;

            // Get current user
            const session = localStorage.getItem("dqp10_session");
            const currentUser = session
              ? JSON.parse(session)
              : { username: "admin" };

            // Create new activity object
            const newActivity = {
              id: newId,
              name: this.formData.name,
              workType: this.formData.workType || "kehoach",
              workGroup: this.formData.workGroup,
              department: this.formData.to,
              startDate: this.formData.startDate,
              endDate: this.formData.endDate,
              documentNumber: this.formData.documentNumber || "",
              location: this.formData.location || "",
              attachedFiles: this.formData.attachedFiles || [],
              tasks: this.formData.tasks.map((task) => ({
                title: task.title,
                team: task.team,
                assignees: task.assignees,
                dueDate: task.dueDate,
                reportFields: task.reportFields || [],
                notes: task.notes || "",
                completed: false,
              })),
              createdBy: currentUser.username,
              createdAt: new Date().toISOString(),
            };

            // Add to activities array
            activities.push(newActivity);

            // Save to localStorage
            localStorage.setItem(
              "dqp10_activities",
              JSON.stringify(activities),
            );

            // Show success message
            alert(
              "‚úÖ T·∫°o ho·∫°t ƒë·ªông th√†nh c√¥ng!" +
                "\n\nüìä Lo·∫°i: " +
                (this.formData.workType === "dotxuat"
                  ? "ƒê·ªôt xu·∫•t"
                  : "K·∫ø ho·∫°ch nƒÉm") +
                "\nüìÅ Nh√≥m: " +
                this.formData.workGroup +
                "\nüë• T·ªï: T·ªï " +
                this.formData.to +
                "\nüìÖ Th·ªùi gian: " +
                this.formData.startDate +
                " - " +
                this.formData.endDate +
                "\nüìã Nhi·ªám v·ª•: " +
                this.formData.tasks.length,
            );

            // Redirect to activity list
            window.location.href = "activity-list.html";
          },
        };
      }
    </script>
  </body>
</html>
